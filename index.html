<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convivial Operating System</title>
    <script src="https://cdn.tailwindcss.com"></script>
  
    <style>
        body { background-color: #fff; font-family: 'Inter', sans-serif; }
        .form-input { border: 1px solid #ff9800; border-radius: 0.25rem; padding: 0.5rem 0.75rem; width: 100%; }
        .action-button { background-color: #6c757d; color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.25rem; transition: background-color 0.2s; display: inline-block; text-align: center; }
        .action-button:hover { background-color: #495057; }
        .action-button.active { background-color: #000; }
        .feature-checkbox { accent-color: #a78bfa; width: 1.25rem; height: 1.25rem; }
        /* Custom slider styles */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 9999px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #343a40; cursor: pointer; margin-top: -6px; }
        input[type=range]::-moz-range-track { width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 9999px; }
        input[type=range]::-moz-range-thumb { height: 16px; width: 16px; border-radius: 50%; background: #343a40; cursor: pointer; }
        .tech-name-button { cursor: pointer; }
        .tech-name-button:hover { text-decoration: underline; }
        .caret { transition: transform 0.2s ease-in-out; display: inline-block; margin-right: 0.5rem; }
        .caret-open { transform: rotate(90deg); }
        .page-content { display: none; }
        .page-content.active { display: block; }
        .admin-table { width: 100%; border-collapse: collapse; }
        .admin-table th, .admin-table td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; font-size: 0.875rem; vertical-align: top; }
        .admin-table th { background-color: #f8fafc; }
        .hidden { display: none; }
        .admin-table .edit-mode-item { display: flex; justify-content: space-between; align-items: center; padding: 2px 0; }
        .new-flag { background-color: #22c55e; color: white; font-size: 0.65rem; font-weight: bold; padding: 2px 5px; border-radius: 9999px; margin-left: 8px; }
        .admin-table .view-mode ul { list-style-position: inside; padding-left: 4px; margin: 0; }
        .admin-table .view-mode li::marker { content: '• '; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="flex justify-between items-center py-4 border-b">
            <div id="home-logo" class="h-8 w-8 grid grid-cols-2 grid-rows-2 gap-1 cursor-pointer">
                <span class="bg-pink-400"></span><span class="bg-blue-400"></span>
                <span class="bg-yellow-400"></span><span class="bg-purple-400"></span>
            </div>
            <nav class="flex space-x-6 text-sm font-medium text-gray-600">
                <a href="#technologies" class="nav-link hover:text-black">All technologies</a>
                <a href="#functions" class="nav-link hover:text-black">Supported functions</a>
                <a href="#why" class="nav-link hover:text-black">Why is this needed</a>
                <a href="#about" class="nav-link hover:text-black">About</a>
            </nav>
        </header>

        <main id="main-content" class="page-content">
            <!-- 1. Hero Section -->
            <section id="hero-section">
                <div class="grid md:grid-cols-2 gap-12 pt-12 pb-16">
                    <div>
                        <h1 class="text-6xl font-bold leading-tight">Convivial<br>Operating<br>System</h1>
                        <p class="mt-4 text-2xl">An evolving toolbox of technologies used by countercultures.</p>
                    </div>
                    <div class="flex items-center">
                        <div class="w-full space-y-2 text-sm">
                            <div class="border p-3"><b>Toolbox of technologies</b> &rarr; A curated a la carte <b>collaboratively updated</b> by usefulness and conviviality.</div>
                            <div class="text-center">&#x2193;</div>
                            <div class="border p-3"><b>Assemble your system</b> &rarr; Select tools useful for supporting your group's particular nature and purpose.</div>
                            <div class="text-center">&#x2193;</div>
                            <div class="border p-3"><b>Evaluate technologies</b> &rarr; Add new or review existing technologies which have been useful (or not) to you.</div>
                        </div>
                    </div>
                </div>
                <div class="text-gray-600 space-y-4 text-sm border-t pt-12 mt-12">
                     <p>The COS is a method for guiding post-growth organisations towards technologies that support their operation - making aspects such as managing a shared economy, communicate with dispersed members or sharing a commons easier.</p>
                     <p>The intention is to facilitate the emergence, functioning and flourishing of groups exploring alternative futures to the present, and strengthen their impact.</p>
                     <div class="flex space-x-4 items-center pt-8">
                        <a href="#assemble" class="action-button nav-link">Assemble your COS</a>
                        <a href="#evaluate" class="action-button nav-link">Evaluate technologies</a>
                        <span id="version-tracker" class="text-xs text-gray-500"></span>
                     </div>
                </div>
            </section>
        </main>

        <!-- 5a. Assemble COS Page -->
        <section id="assemble-page" class="page-content pt-12">
            <div class="grid md:grid-cols-2 gap-8 relative">
                <div class="absolute top-0 bottom-0 left-1/2 w-px bg-gray-200"></div>
                <div class="pr-8">
                    <h3 class="text-2xl font-bold">ASSEMBLY</h3>
                    <p class="text-gray-600 mt-2">Below are features others have found useful in setting up operational support for their group.</p>
                    <div id="assemble-features-container" class="mt-6 space-y-2"></div>
                </div>
                <div class="pl-8">
                    <h3 class="text-2xl font-bold">COS</h3>
                    <p class="text-gray-600 mt-2">The below list is ranked by how well they match your choices on the left.</p>
                    <div id="assemble-results-container" class="mt-6 space-y-6"></div>
                </div>
            </div>
        </section>

        <!-- 5b. Evaluate Technologies Page -->
        <section id="evaluate-page" class="page-content pt-12">
             <div class="max-w-2xl mx-auto">
                <h3 class="text-2xl font-bold">EVALUATION</h3>
                <div id="evaluate-form-container" class="mt-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium">Which technology are we talking about?</label>
                        <select id="evaluate-tech-select" class="form-input w-full mt-1"></select>
                        <input type="text" id="new-technology-input" class="form-input w-full mt-2 text-sm" placeholder="Add a new technology...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Needed level of tech proficiency</label>
                        <select id="evaluate-tech-proficiency" class="form-input w-full mt-1"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">What does it help out with?</label>
                        <input type="search" id="evaluate-features-search" class="form-input w-full mt-1 text-sm" placeholder="Search for features...">
                        <div id="evaluate-features-container" class="mt-2 p-2 border border-gray-300 rounded-md max-h-40 overflow-y-auto"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Which ends does it support?</label>
                        <div id="evaluate-purposes-container" class="mt-1 p-2 border border-gray-300 rounded-md max-h-32 overflow-y-auto"></div>
                        <input type="text" id="new-purpose-input" class="form-input w-full mt-2 text-sm" placeholder="Add a new purpose...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Comments</label>
                        <textarea id="evaluation-comment" class="form-input w-full mt-1" rows="3" placeholder="Your review of how this was useful/not useful for your group."></textarea>
                    </div>
                    <div id="conviviality-questions" class="space-y-4 pt-2">
                         <label class="block text-sm font-medium">Conviviality Questions</label>
                         <div id="conviviality-sliders-container" class="space-y-3 text-xs text-gray-600">
                         </div>
                    </div>
                    <div class="flex space-x-4 pt-2">
                        <button id="save-evaluation-button" class="action-button">Save</button>
                    </div>
                    <p id="save-confirmation-message" class="text-sm text-green-600 mt-4 hidden"></p>
                </div>
            </div>
        </section>

        <section id="technologies-page" class="page-content pt-12">
             <h1 class="text-4xl font-bold mb-8">Technologies</h1>
             <div id="technologies-list-container" class="space-y-8"></div>
        </section>

        <section id="functions-page" class="page-content pt-12">
            <h1 class="text-4xl font-bold mb-8">Supported Functions</h1>
            <div class="space-y-8 text-gray-700">
                <div>
                    <h2 class="text-2xl font-semibold mb-2">Communication</h2>
                    <p>Effective communication is the bedrock of any collaborative group. For countercultures, this means creating spaces for dialogue that are secure, transparent, and owned by the community itself, rather than relying on platforms that may exploit user data. Supporting this function allows groups to find and connect with like-minded people, coordinate projects, and build trust without compromising their values.</p>
                </div>
                <div>
                    <h2 class="text-2xl font-semibold mb-2">Economy</h2>
                    <p>Moving beyond the growth paradigm requires creating alternative economic models. This function supports groups in managing shared finances, creating community currencies, and developing systems of value that reflect their principles, such as rewarding contributions rather than accumulating capital. Technologies that support this function are crucial for building economic resilience and autonomy.</p>
                </div>
                <div>
                    <h2 class="text-2xl font-semibold mb-2">Admin & Organisation</h2>
                    <p>Self-organisation is a core tenet of many alternative groups, but it can be logistically challenging. This function is about providing tools that reduce the burden of administration—the "unpaid jobs" that can lead to burnout. By simplifying task tracking, decision-making, and coordination, these technologies free up time and energy for the "heart work" that truly builds community.</p>
                </div>
                 <div>
                    <h2 class="text-2xl font-semibold mb-2">Commons</h2>
                    <p>The concept of the commons—shared resources managed collectively—is central to post-growth thinking. This function supports the management of both digital commons (like open-source knowledge) and physical commons (like tools, land, or shared spaces). It enables groups to bypass traditional ownership models and create systems of access and stewardship that are equitable and sustainable.</p>
                </div>
                <div>
                    <h2 class="text-2xl font-semibold mb-2">Connection</h2>
                    <p>This function relates to building a shared identity and knowledge base. For countercultures to thrive and evolve, they need ways to document their learnings, share them with others, and build upon a collective intelligence. Supporting this function helps create resilient networks of groups that can learn from each other, fostering a broader movement of transformative change.</p>
                </div>
            </div>
        </section>

        <section id="why-page" class="page-content pt-12">
            <h1 class="text-4xl font-bold mb-4">Why is this Needed?</h1>
            <div class="space-y-4 text-gray-700 leading-relaxed">
                <p>If a transformative system change is needed to transition to sustainable patterns, then efforts must be focused on defining what change we wish to achieve, who is actually in a position to implement this change, and how they may go about doing so. The current dominant paradigm of perpetual economic growth is increasingly criticized for being both a cause of and a barrier to solving our most pressing social and environmental crises.</p>
                <p>This project is motivated by an understanding that the society we are currently living in is influenced by a new spirit of capitalism that tends to absorb critiques without making fundamental changes. The direction we are heading towards seems balanced either towards continued growth—which would be detrimental to civilization as we know it—or towards post-growth, which requires transformative change efforts.</p>
                <p>This work positions **alternative groups**—intentional communities, collectives, and associations—as pivotal actors in implementing a diversity of post-growth futures. Unlike top-down approaches, these groups are already living the change, acting as radical laboratories for sustainable transformation. However, they often lack the tools to effectively organize and scale their impact.</p>
                <p>Digital technology presents an ambiguous potential. While often used to extract value and control users in what has been termed "platform capitalism," it can also be appropriated to support autonomy, collaboration, and self-organisation. This project explores how to provide a scaffolding for alternative groups to translate their ideas into practice, empowering them to build a collection of futures that experiment with different forms of convivial life.</p>
            </div>
        </section>

        <section id="about-page" class="page-content pt-12">
             <h1 class="text-4xl font-bold mb-4">About the Project</h1>
             <div class="space-y-4 text-gray-700 leading-relaxed">
                <p>This project, titled "Empowering radical laboratories of change - Digital structures for alternative groups," explores how technologies can support alternative groups in implementing post-growth practices. It stems from a journey through architecture, international development, and software engineering, which revealed a common challenge: the structures that shape our lives, whether physical or digital, often serve a system of perpetual growth that is fundamentally unsustainable.</p>
                <p>Disillusioned with both top-down change and the value-extractive nature of startup culture, the focus turned to those working in parallel with the dominant system: alternative groups. These groups are actively defining and living the change they wish to see, offering a rare sense of hope for the future.</p>
                <p>The central research question is: **How can technologies support alternative groups implementing post-growth in practice?**</p>
                <p>To answer this, the research moves from theory to practice:</p>
                <ul class="list-disc list-inside ml-4 space-y-2">
                    <li>**Exploring the Tools:** Mapping the landscape of post-2004 technologies (like collaborative commons and decentralised production) that could be useful for post-growth aims.</li>
                    <li>**Understanding the Actors:** Interviewing members of an alternative group to understand their context, needs, and the real-world barriers to adopting new technologies.</li>
                    <li>**Building the Bridge:** This application, the Convivial Operating System (COS), is the synthesis of that research—a practical tool designed to help groups find, evaluate, and assemble their own set of supportive, value-aligned technologies.</li>
                </ul>
             </div>
        </section>
        
        <section id="admin-login-page" class="page-content pt-12">
            <div class="max-w-md mx-auto">
                <h2 class="text-2xl font-bold mb-4">Admin Login</h2>
                <form id="admin-login-form" class="space-y-4">
                    <div>
                        <label for="admin-email" class="block text-sm font-medium">Email</label>
                        <input type="email" id="admin-email" class="form-input w-full mt-1" value="admin@cos.com">
                    </div>
                    <div>
                        <label for="admin-password" class="block text-sm font-medium">Password</label>
                        <input type="password" id="admin-password" class="form-input w-full mt-1" value="password">
                    </div>
                    <p id="admin-login-error" class="text-red-500 text-sm hidden">Invalid credentials.</p>
                    <button type="submit" class="action-button">Login</button>
                </form>
            </div>
        </section>
        
        <section id="admin-dashboard-page" class="page-content pt-12">
            <h1 class="text-4xl font-bold mb-8">Admin Dashboard</h1>
            <div id="admin-dashboard-container" class="space-y-12"></div>
        </section>

        <footer class="text-right py-8 mt-12 border-t">
            <a href="#admin-login" id="admin-login-link" class="nav-link text-xs text-gray-500 hover:text-black">Admin Login</a>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA ---
        const appData = {
            version: 1.0,
            functions: [
                { id: 'comm', name: 'Communication', color: '#facc15', accent: 'accent-yellow-400' },
                { id: 'econ', name: 'Economy', color: '#f472b6', accent: 'accent-pink-400' },
                { id: 'admin', name: 'Admin', color: '#a78bfa', accent: 'accent-purple-400' },
                { id: 'commons', name: 'Commons', color: '#60a5fa', accent: 'accent-blue-400' },
                { id: 'conn', name: 'Connection', color: '#4ade80', accent: 'accent-green-400' },
            ],
            features: [
                {id: 'f1', name: 'Find and connect with others interested in the group', functionId: 'comm'},
                {id: 'f2', name: 'Communicate around projects and events', functionId: 'comm'},
                {id: 'f3', name: 'Brainstorm around an idea and work on it together', functionId: 'comm'},
                {id: 'f4', name: 'Manage shared finances', functionId: 'econ'},
                {id: 'f5', name: 'Create and manage budgets', functionId: 'econ'},
                {id: 'f6', name: 'Track tasks and projects', functionId: 'admin'},
                {id: 'f7', name: 'Store and share documents', functionId: 'admin'},
                {id: 'f8', name: 'Book shared resources', functionId: 'commons'},
                {id: 'f9', name: 'Build a shared knowledge base', functionId: 'conn'},
                {id: 'f10', name: 'Distributing the weight of administration', functionId: 'admin'},
                {id: 'f11', name: 'Gathering important information in one place', functionId: 'admin'},
                {id: 'f12', name: 'Handle reimbursement of expenses', functionId: 'admin'},
                {id: 'f13', name: 'Handling all membership fees', functionId: 'admin'},
                {id: 'f14', name: 'Manage and get funding for events', functionId: 'admin'},
                {id: 'f15', name: 'Receive funding from outside sources', functionId: 'admin'},
            ],
            techProficiencyLevels: [
                { id: 1, name: 'Happy luddites' },
                { id: 2, name: 'Basic tool users (email, social media)' },
                { id: 3, name: 'Comfortable with new software' },
                { id: 4, name: 'Some tech experts in the group' },
                { id: 5, name: 'Able to code' },
            ],
            technologies: [
                { id: 1, name: 'Discord', evaluations: [
                    { techProficiency: 3, convivialityScore: 7.5, comment: "Great for quick chats, but can be overwhelming.", features: ['f1', 'f2'], purposes: ['p1'] },
                    { techProficiency: 4, convivialityScore: 6, comment: "Video quality is decent.", features: ['f2', 'f3'], purposes: ['p1'] }
                ]},
                { id: 2, name: 'WhatsApp', evaluations: [
                     { techProficiency: 1, convivialityScore: 8, comment: "Super easy to use for everyone in our group.", features: ['f1', 'f2'], purposes: ['p1'] }
                ]},
                { id: 3, name: 'Open Collective', evaluations: [
                    { techProficiency: 2, convivialityScore: 9.2, comment: "A game-changer for transparent finances and reducing admin load.", features: ['f10', 'f11', 'f12', 'f13', 'f14', 'f15'], purposes: ['p2'] }
                ] },
                { id: 4, name: 'Trello', evaluations: [
                    { techProficiency: 2, convivialityScore: 9, comment: "Visual and intuitive for managing our projects.", features: ['f6'], purposes: ['p1', 'p2'] }
                ]},
                { id: 5, name: 'Facebook', evaluations: [
                    { techProficiency: 4, convivialityScore: 1.5, comment: "Feels invasive and constantly tries to sell you things. Hard to control your own data.", features: ['f1', 'f2'], purposes: ['p1'] }
                ]},
            ],
            purposes: [
                { id: 'p1', name: 'Own land' },
                { id: 'p2', name: 'Own property' },
                { id: 'p3', name: 'Be self-sufficient in energy' }
            ],
            convivialityQuestions: [
                { id: 'ease', question: 'Is it easy to learn and use?' },
                { id: 'adaptation', question: 'Does it allow for user modification and adaptation?' },
                { id: 'autonomy', question: 'Does it respect user autonomy and privacy?' },
            ]
        };

        const dataService = {
            getVersion: () => appData.version,
            incrementVersion: () => { appData.version = parseFloat((appData.version + 0.1).toFixed(1)); },
            // GETTERS
            getFunctions: () => appData.functions,
            getFeatures: () => appData.features,
            getTechnologies: () => appData.technologies,
            getPurposes: () => appData.purposes,
            getTechProficiencyLevels: () => appData.techProficiencyLevels,
            getConvivialityQuestions: () => appData.convivialityQuestions,
            getFeaturesByFunction: (functionId) => appData.features.filter(f => f.functionId === functionId),
            getFeatureById: (id) => appData.features.find(f => f.id === id),
            getTechnologyById: (id) => appData.technologies.find(t => t.id === id),
            
            // ADDERS
            addFunction: (name) => {
                const colors = ['#facc15', '#f472b6', '#a78bfa', '#60a5fa', '#4ade80', '#f87171', '#818cf8'];
                const accents = ['accent-yellow-400', 'accent-pink-400', 'accent-purple-400', 'accent-blue-400', 'accent-green-400', 'accent-red-400', 'accent-indigo-400'];
                const nextColorIndex = appData.functions.length % colors.length;
                const newFunc = { id: `func${Date.now()}`, name, color: colors[nextColorIndex], accent: accents[nextColorIndex] };
                appData.functions.push(newFunc);
            },
            addFeature: (name, functionId) => {
                const newFeature = { id: `f${Date.now()}`, name, functionId, isNew: true };
                appData.features.push(newFeature);
            },
            addTechnology: (name) => {
                const newTech = { id: Date.now(), name, evaluations: [] };
                appData.technologies.push(newTech);
                return newTech;
            },
            addEvaluation: (techId, evaluationData) => {
                const tech = dataService.getTechnologyById(techId);
                if (tech) tech.evaluations.push(evaluationData);
            },
            addPurpose: (name) => {
                appData.purposes.push({ id: `p${Date.now()}`, name });
            },
             addTechProficiency: (name) => {
                const maxLevel = Math.max(0, ...appData.techProficiencyLevels.map(l => l.id));
                appData.techProficiencyLevels.push({ id: maxLevel + 1, name });
            },
            addConvivialityQuestion: (question) => {
                appData.convivialityQuestions.push({ id: `conv${Date.now()}`, question });
            },
            
            // UPDATERS
            updateFunction: (id, newName, newColor) => {
                const func = appData.functions.find(f => f.id == id);
                if (func) {
                    func.name = newName;
                    func.color = newColor;
                }
            },
            updateFeature: (id, newName, newFunctionId) => {
                const feature = appData.features.find(f => f.id == id);
                if (feature) {
                    feature.name = newName;
                    feature.functionId = newFunctionId;
                }
            },
            updateTechnology: (id, newName, featureIds) => {
                const tech = appData.technologies.find(t => t.id == id);
                if (tech) {
                    tech.name = newName;
                    let adminEval = tech.evaluations.find(ev => ev.isAdminAssigned);
                    if (adminEval) {
                        adminEval.features = featureIds;
                    } else {
                        tech.evaluations.push({ 
                            features: featureIds, 
                            isAdminAssigned: true,
                            comment: "Admin-assigned features.", 
                            convivialityScore: 0, 
                            techProficiency: 0, 
                            purposes: [] 
                        });
                    }
                }
            },
             updatePurpose: (id, newName) => {
                const item = appData.purposes.find(p => p.id == id);
                if (item) item.name = newName;
            },
            updateTechProficiency: (id, newName) => {
                const item = appData.techProficiencyLevels.find(l => l.id == id);
                if (item) item.name = newName;
            },
            updateConvivialityQuestion: (id, newQuestion) => {
                const item = appData.convivialityQuestions.find(q => q.id == id);
                if (item) item.question = newQuestion;
            },

            // DELETERS
            deleteFunction: (id) => {
                appData.functions = appData.functions.filter(f => f.id != id);
                appData.features = appData.features.filter(f => f.functionId != id);
            },
            deleteFeature: (id) => {
                appData.features = appData.features.filter(f => f.id != id);
            },
            deleteTechnology: (id) => {
                appData.technologies = appData.technologies.filter(t => t.id != id);
            },
            deletePurpose: (id) => {
                appData.purposes = appData.purposes.filter(p => p.id != id);
            },
            deleteTechProficiency: (id) => {
                appData.techProficiencyLevels = appData.techProficiencyLevels.filter(l => l.id != id);
            },
             deleteConvivialityQuestion: (id) => {
                appData.convivialityQuestions = appData.convivialityQuestions.filter(q => q.id != id);
            }
        };

        // --- ELEMENTS ---
        const pageContents = document.querySelectorAll('.page-content');
        const homeLogo = document.getElementById('home-logo');
        const technologiesListContainer = document.getElementById('technologies-list-container');
        const assembleFeaturesContainer = document.getElementById('assemble-features-container');
        const assembleResultsContainer = document.getElementById('assemble-results-container');
        const evaluateTechSelect = document.getElementById('evaluate-tech-select');
        const newTechnologyInput = document.getElementById('new-technology-input');
        const evaluateTechProficiency = document.getElementById('evaluate-tech-proficiency');
        const evaluateFeaturesSearch = document.getElementById('evaluate-features-search');
        const evaluateFeaturesContainer = document.getElementById('evaluate-features-container');
        const newPurposeInput = document.getElementById('new-purpose-input');
        const saveEvaluationButton = document.getElementById('save-evaluation-button');
        const evaluationComment = document.getElementById('evaluation-comment');
        const convivialitySlidersContainer = document.getElementById('conviviality-sliders-container');
        const saveConfirmationMessage = document.getElementById('save-confirmation-message');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminDashboardContainer = document.getElementById('admin-dashboard-container');
        const versionTracker = document.getElementById('version-tracker');

        // --- HELPERS ---
        const getAggregateData = (technology) => {
            const adminEval = technology.evaluations.find(ev => ev.isAdminAssigned);
            const userEvals = technology.evaluations.filter(ev => !ev.isAdminAssigned);

            const features = adminEval ? adminEval.features : [...new Set(userEvals.flatMap(ev => ev.features))];
            
            const functionIds = [...new Set(features.map(featureId => {
                const feature = dataService.getFeatureById(featureId);
                return feature ? feature.functionId : null;
            }).filter(Boolean))];

            if (userEvals.length === 0) {
                 return { conviviality: null, proficiency: null, features, functionIds };
            }

            const totalConv = userEvals.reduce((sum, ev) => sum + ev.convivialityScore, 0);
            const totalProf = userEvals.reduce((sum, ev) => sum + ev.techProficiency, 0);

            return {
                conviviality: totalConv / userEvals.length,
                proficiency: totalProf / userEvals.length,
                features,
                functionIds
            };
        };
        
        const getScoreColor = (score, type) => {
            if (score === null) return 'text-gray-700';
            if (type === 'conviviality') {
                if (score >= 7) return 'text-green-600';
                else if (score >= 4) return 'text-yellow-600';
                else return 'text-red-600';
            } else if (type === 'tech') {
                if (score >= 4) return 'text-red-600';
                else if (score >= 2.5) return 'text-yellow-600';
                else return 'text-green-600';
            }
            return 'text-gray-700';
        };

        // --- STATE MANAGEMENT ---
        const showPage = (pageId) => {
            pageContents.forEach(page => {
                if (page.id === pageId) {
                    page.classList.add('active');
                    if(page.id === 'assemble-page') {
                        renderAssembleView();
                        renderAssembleResults();
                    }
                    if(page.id === 'evaluate-page') {
                        renderEvaluateView();
                    }
                    if(page.id === 'technologies-page') {
                        renderTechnologiesList(technologiesListContainer, 'technologies');
                    }
                    if(page.id === 'admin-dashboard-page') {
                        renderAdminDashboard();
                    }
                } else {
                    page.classList.remove('active');
                }
            });
        };
        
        // --- RENDER FUNCTIONS ---
        const updateVersionTracker = () => {
            versionTracker.textContent = `Version ${dataService.getVersion().toFixed(1)}`;
        };

        const populateTechProficiencyDropdowns = () => {
            const dropdown = document.getElementById('evaluate-tech-proficiency');
            if(!dropdown) return;
            dropdown.innerHTML = '';
            dataService.getTechProficiencyLevels().forEach(level => {
                const option = document.createElement('option');
                option.value = level.id;
                option.textContent = level.name;
                dropdown.appendChild(option);
            });
        };

        const renderConvivialitySliders = () => {
            convivialitySlidersContainer.innerHTML = dataService.getConvivialityQuestions().map(q => `
                <div>
                    <label>${q.question}</label>
                    <input type="range" min="1" max="10" value="5" class="w-full mt-1" data-conv-id="${q.id}">
                </div>
            `).join('');
        };
        
        const renderAssembleView = () => {
            const allFeatures = dataService.getFeatures();
            assembleFeaturesContainer.innerHTML = allFeatures.map(feat => {
                const newFlag = feat.isNew ? '<span class="new-flag">new</span>' : '';
                return `
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" value="${feat.id}" class="feature-checkbox">
                        <span class="text-gray-700">${feat.name}</span>
                        ${newFlag}
                    </label>
                `;
            }).join('');
        };
        
        const renderAssembleResults = (selectedFeatureIds = []) => {
            assembleResultsContainer.innerHTML = '';
            if (selectedFeatureIds.length === 0) {
                 assembleResultsContainer.innerHTML = `<p class="text-gray-500">Select features on the left to see results.</p>`;
                 return;
            }

            const rankedTech = dataService.getTechnologies().map(tech => {
                const aggData = getAggregateData(tech);
                const matchScore = selectedFeatureIds.reduce((score, sfid) => {
                    return score + (aggData.features.includes(sfid) ? 1 : 0);
                }, 0);
                return { ...tech, matchScore, aggData };
            }).filter(tech => tech.matchScore > 0);

            rankedTech.sort((a, b) => {
                if (b.matchScore !== a.matchScore) {
                    return b.matchScore - a.matchScore;
                }
                if ((b.aggData.conviviality || 0) !== (a.aggData.conviviality || 0)) {
                    return (b.aggData.conviviality || 0) - (a.aggData.conviviality || 0);
                }
                return (a.aggData.proficiency || 10) - (b.aggData.proficiency || 10);
            });


            if (rankedTech.length === 0) {
                 assembleResultsContainer.innerHTML = `<p class="text-gray-500">No technologies match the selected features.</p>`;
                 return;
            }

            const headerHTML = `
                <div class="grid grid-cols-[1fr_auto] gap-4 text-xs text-gray-500 font-semibold mb-2">
                    <span></span> <!-- Spacer for tech name -->
                    <div class="grid grid-cols-3 gap-4">
                        <span class="w-24 text-center">Match</span>
                        <span class="w-24 text-center">Conviviality</span>
                        <span class="w-24 text-center">Tech proficiency</span>
                    </div>
                </div>
            `;
            assembleResultsContainer.innerHTML = headerHTML;

            const relevantFunctionIds = [...new Set(rankedTech.flatMap(t => t.aggData.functionIds))];

            dataService.getFunctions().forEach(func => {
                const techForFunc = rankedTech.filter(t => t.aggData.functionIds.includes(func.id));
                if (techForFunc.length > 0) {
                    const techHTML = techForFunc.map(t => {
                        const scores = t.aggData;
                        const convScoreText = scores.conviviality !== null ? scores.conviviality.toFixed(1) : '-';
                        const techScoreText = scores.proficiency !== null ? scores.proficiency.toFixed(1) : '-';
                        const matchText = `${t.matchScore}/${selectedFeatureIds.length}`;
                        return `
                            <div>
                                <div class="grid grid-cols-[1fr_auto] gap-4 items-center text-sm py-1">
                                    <div class="flex items-center tech-name-button" data-tech-id="${t.id}">
                                        <span class="caret">&#9656;</span>
                                        <span>${t.name}</span>
                                    </div>
                                    <div class="grid grid-cols-3 gap-4">
                                        <span class="font-semibold w-24 text-center text-blue-600">${matchText}</span>
                                        <span class="font-semibold w-24 text-center ${getScoreColor(scores.conviviality, 'conviviality')}">${convScoreText}</span>
                                        <span class="font-semibold w-24 text-center ${getScoreColor(scores.proficiency, 'tech')}">${techScoreText}</span>
                                    </div>
                                </div>
                                <div id="comments-assemble-${t.id}" class="hidden text-xs text-gray-600 pl-4 py-2"></div>
                            </div>
                        `;
                    }).join('');

                    const funcResultEl = document.createElement('div');
                    funcResultEl.innerHTML = `
                        <div class="flex items-center space-x-3 mb-2 pt-4">
                            <div style="background-color: ${func.color}" class="w-5 h-5"></div>
                            <h4 class="font-semibold">${func.name}</h4>
                        </div>
                        <div class="space-y-1">${techHTML}</div>
                    `;
                    assembleResultsContainer.appendChild(funcResultEl);
                }
            });
        };

        const renderEvaluateView = () => {
            renderTechnologyDropdown();
            renderEvaluateFeatures();
            renderEvaluatePurposes();
            populateTechProficiencyDropdowns();
            renderConvivialitySliders();
        };

        const renderTechnologyDropdown = () => {
            evaluateTechSelect.innerHTML = '<option value="">Select a technology</option>';
            dataService.getTechnologies().forEach(tech => {
                const option = document.createElement('option');
                option.value = tech.id;
                option.textContent = tech.name;
                evaluateTechSelect.appendChild(option);
            });
        };
        
        const renderEvaluateFeatures = (searchTerm = '') => {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const allFeatures = dataService.getFeatures();
            evaluateFeaturesContainer.innerHTML = allFeatures
                .filter(feat => feat.name.toLowerCase().includes(lowerCaseSearchTerm))
                .map(feat => `
                <label class="flex items-center space-x-2 text-sm p-1">
                    <input type="checkbox" value="${feat.id}" class="h-4 w-4 rounded border-gray-300">
                    <span>${feat.name}</span>
                </label>
            `).join('');
        };
        
        const renderEvaluatePurposes = () => {
            document.getElementById('evaluate-purposes-container').innerHTML = '';
            dataService.getPurposes().forEach(purpose => {
                const purposeHTML = `
                    <label class="flex items-center space-x-2 text-sm">
                        <input type="checkbox" value="${purpose.id}" class="h-4 w-4 rounded border-gray-300">
                        <span>${purpose.name}</span>
                    </label>
                `;
                document.getElementById('evaluate-purposes-container').innerHTML += purposeHTML;
            });
        };

        const renderTechnologiesList = (container, viewName) => {
            container.innerHTML = '';
            
            const headerHTML = `
                 <div class="grid grid-cols-[1fr_auto] gap-4 text-xs text-gray-500 font-semibold mb-2">
                    <span></span> <!-- Spacer for tech name -->
                    <div class="grid grid-cols-2 gap-4">
                        <span class="w-24 text-center">Conviviality</span>
                        <span class="w-24 text-center">Tech proficiency</span>
                    </div>
                </div>
            `;
            container.innerHTML = headerHTML;

            dataService.getFunctions().forEach(func => {
                let techForFunc = dataService.getTechnologies().filter(t => getAggregateData(t).functionIds.includes(func.id));
                
                techForFunc.sort((a, b) => {
                    const scoreA = getAggregateData(a);
                    const scoreB = getAggregateData(b);
                    if ((scoreB.conviviality || 0) !== (scoreA.conviviality || 0)) {
                        return (scoreB.conviviality || 0) - (scoreA.conviviality || 0);
                    }
                    return (scoreA.proficiency || 10) - (scoreB.proficiency || 10);
                });

                if (techForFunc.length > 0) {
                    const techHTML = techForFunc.map(t => {
                        const scores = getAggregateData(t);
                        const convScoreText = scores.conviviality !== null ? scores.conviviality.toFixed(1) : '-';
                        const techScoreText = scores.proficiency !== null ? scores.proficiency.toFixed(1) : '-';
                        return `
                        <div>
                            <div class="grid grid-cols-[1fr_auto] gap-4 items-center text-sm py-1">
                                <div class="flex items-center tech-name-button" data-tech-id="${t.id}">
                                    <span class="caret">&#9656;</span>
                                    <span>${t.name}</span>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                   <span class="font-semibold w-24 text-center ${getScoreColor(scores.conviviality, 'conviviality')}">${convScoreText}</span>
                                   <span class="font-semibold w-24 text-center ${getScoreColor(scores.proficiency, 'tech')}">${techScoreText}</span>
                                </div>
                            </div>
                            <div id="comments-${viewName}-${t.id}" class="hidden text-xs text-gray-600 pl-4 py-2"></div>
                        </div>
                    `}).join('');
                    const funcResultEl = document.createElement('div');
                    funcResultEl.innerHTML = `
                        <div class="flex items-center space-x-3 mb-2 pt-4">
                            <div style="background-color: ${func.color}" class="w-5 h-5"></div>
                            <h4 class="font-semibold">${func.name}</h4>
                        </div>
                        <div class="space-y-1">${techHTML}</div>
                    `;
                    container.appendChild(funcResultEl);
                }
            });
        };
        
        const renderAdminDashboard = () => {
            adminDashboardContainer.innerHTML = `
                <div class="space-y-8">
                    <!-- Functions -->
                    <div>
                        <h3 class="text-xl font-bold mb-2">Manage Functions</h3>
                        <table class="admin-table">
                            <thead><tr><th>Name</th><th>Color</th><th class="w-40">Actions</th></tr></thead>
                            <tbody id="admin-functions-body"></tbody>
                        </table>
                        <form id="add-function-form" class="mt-4 flex space-x-2"><input type="text" placeholder="New function name" class="form-input flex-grow"><button type="submit" class="action-button text-sm !py-2 !px-4">Add</button></form>
                    </div>
                    <!-- Features -->
                    <div>
                        <h3 class="text-xl font-bold mb-2">Manage Features</h3>
                        <table class="admin-table">
                            <thead><tr><th>Name</th><th>Function</th><th>Used By</th><th class="w-40">Actions</th></tr></thead>
                            <tbody id="admin-features-body"></tbody>
                        </table>
                         <form id="add-feature-form" class="mt-4 flex space-x-2"><input type="text" placeholder="New feature name" class="form-input flex-grow"><select id="add-feature-function-select" class="form-input"></select><button type="submit" class="action-button text-sm !py-2 !px-4">Add</button></form>
                    </div>
                    <!-- Technologies -->
                    <div>
                         <h3 class="text-xl font-bold mb-2">Manage Technologies</h3>
                        <table class="admin-table">
                            <thead><tr><th>Name</th><th>Associated Features</th><th class="w-40">Actions</th></tr></thead>
                            <tbody id="admin-technologies-body"></tbody>
                        </table>
                         <form id="add-technology-form" class="mt-4 flex space-x-2"><input type="text" placeholder="New technology name" class="form-input flex-grow"><button type="submit" class="action-button text-sm !py-2 !px-4">Add</button></form>
                    </div>
                    <!-- Purposes -->
                    <div>
                        <h3 class="text-xl font-bold mb-2">Manage Purposes</h3>
                        <table class="admin-table">
                            <thead><tr><th>Name</th><th class="w-40">Actions</th></tr></thead>
                            <tbody id="admin-purposes-body"></tbody>
                        </table>
                        <form id="add-purpose-form" class="mt-4 flex space-x-2"><input type="text" placeholder="New purpose" class="form-input flex-grow"><button type="submit" class="action-button text-sm !py-2 !px-4">Add</button></form>
                    </div>
                    <!-- Tech Proficiency -->
                    <div>
                        <h3 class="text-xl font-bold mb-2">Manage Tech Proficiency</h3>
                        <table class="admin-table">
                            <thead><tr><th>Name</th><th class="w-40">Actions</th></tr></thead>
                            <tbody id="admin-techproficiency-body"></tbody>
                        </table>
                         <form id="add-techproficiency-form" class="mt-4 flex space-x-2"><input type="text" placeholder="New level" class="form-input flex-grow"><button type="submit" class="action-button text-sm !py-2 !px-4">Add</button></form>
                    </div>
                    <!-- Conviviality Questions -->
                    <div>
                        <h3 class="text-xl font-bold mb-2">Manage Conviviality Questions</h3>
                        <table class="admin-table">
                            <thead><tr><th>Question</th><th class="w-40">Actions</th></tr></thead>
                            <tbody id="admin-conviviality-body"></tbody>
                        </table>
                        <form id="add-conviviality-form" class="mt-4 flex space-x-2"><input type="text" placeholder="New question" class="form-input flex-grow"><button type="submit" class="action-button text-sm !py-2 !px-4">Add</button></form>
                    </div>
                </div>
            `;
            renderAdminTables();
        };

        const renderAdminTables = () => {
            // Functions
            document.getElementById('admin-functions-body').innerHTML = dataService.getFunctions().map(f => `
                <tr data-id="${f.id}" data-type="function">
                    <td>
                        <span class="view-mode">${f.name}</span>
                        <input type="text" value="${f.name}" class="form-input edit-mode hidden">
                    </td>
                    <td>
                        <span class="view-mode flex items-center"><div style="background-color:${f.color}" class="w-4 h-4 mr-2 border"></div> ${f.color}</span>
                        <input type="color" value="${f.color}" class="form-input edit-mode hidden">
                    </td>
                    <td><button class="text-blue-500 text-xs mr-2" data-action="edit">Edit</button><button class="text-red-500 text-xs" data-action="delete">Delete</button></td>
                </tr>`).join('');

            // Features
            const functionOptions = dataService.getFunctions().map(f => `<option value="${f.id}">${f.name}</option>`).join('');
            document.getElementById('add-feature-function-select').innerHTML = functionOptions;
            document.getElementById('admin-features-body').innerHTML = dataService.getFeatures().map(f => {
                const functionName = dataService.getFunctions().find(fn => fn.id === f.functionId)?.name || 'N/A';
                const techList = dataService.getTechnologies().filter(t => getAggregateData(t).features.includes(f.id));
                const techListHTML = techList.length > 0 ? `<ul>${techList.map(t => `<li>${t.name}</li>`).join('')}</ul>` : 'None';

                return `
                <tr data-id="${f.id}" data-type="feature">
                    <td>
                        <span class="view-mode">${f.name}</span>
                        <input type="text" value="${f.name}" class="form-input edit-mode hidden">
                    </td>
                    <td>
                        <span class="view-mode">${functionName}</span>
                        <select class="form-input edit-mode hidden">${functionOptions.replace(`value="${f.functionId}"`, `value="${f.functionId}" selected`)}</select>
                    </td>
                    <td><div class="view-mode">${techListHTML}</div></td>
                    <td><button class="text-blue-500 text-xs mr-2" data-action="edit">Edit</button><button class="text-red-500 text-xs" data-action="delete">Delete</button></td>
                </tr>`;
            }).join('');

            // Technologies
            document.getElementById('admin-technologies-body').innerHTML = dataService.getTechnologies().map(t => {
                const aggData = getAggregateData(t);
                const featureList = `<ul>${aggData.features.map(fid => `<li>${dataService.getFeatureById(fid)?.name || ''}</li>`).join('')}</ul>`;
                
                const unassociatedFeatures = dataService.getFeatures().filter(f => !aggData.features.includes(f.id));
                const addFeatureContainerHTML = unassociatedFeatures.length > 0 ? `
                    <div class="add-feature-container flex space-x-2 mt-2">
                        <label class="text-xs text-gray-500 w-full whitespace-nowrap pt-2">Associate a feature:</label>
                        <select class="form-input flex-grow">${unassociatedFeatures.map(f => `<option value="${f.id}">${f.name}</option>`).join('')}</select>
                        <button class="text-sm action-button !py-1 !px-2" data-action="add-feature">Add</button>
                    </div>` : '';

                const editModeFeaturesHTML = `
                    <div class="edit-mode-features-list space-y-1">
                        ${aggData.features.map(fid => {
                            const feature = dataService.getFeatureById(fid);
                            return feature ? `<div class="edit-mode-item" data-feature-id="${fid}"><span>${feature.name}</span><button class="text-red-500 text-xs" data-action="remove-feature">&times;</button></div>` : '';
                        }).join('')}
                    </div>
                    ${addFeatureContainerHTML}`;

                return `
                <tr data-id="${t.id}" data-type="technology">
                    <td>
                        <span class="view-mode">${t.name}</span>
                        <input type="text" value="${t.name}" class="form-input edit-mode hidden">
                    </td>
                    <td>
                        <div class="view-mode">${aggData.features.length > 0 ? featureList : 'None'}</div>
                        <div class="edit-mode hidden">${editModeFeaturesHTML}</div>
                    </td>
                    <td><button class="text-blue-500 text-xs mr-2" data-action="edit">Edit</button><button class="text-red-500 text-xs" data-action="delete">Delete</button></td>
                </tr>`;
            }).join('');

             // Other Tables
            document.getElementById('admin-purposes-body').innerHTML = dataService.getPurposes().map(item => `
                <tr data-id="${item.id}" data-type="purpose"><td><span class="view-mode">${item.name}</span><input type="text" value="${item.name}" class="form-input edit-mode hidden"></td><td><button class="text-blue-500 text-xs mr-2" data-action="edit">Edit</button><button class="text-red-500 text-xs" data-action="delete">Delete</button></td></tr>`).join('');
            document.getElementById('admin-techproficiency-body').innerHTML = dataService.getTechProficiencyLevels().map(item => `
                <tr data-id="${item.id}" data-type="techproficiency"><td><span class="view-mode">${item.name}</span><input type="text" value="${item.name}" class="form-input edit-mode hidden"></td><td><button class="text-blue-500 text-xs mr-2" data-action="edit">Edit</button><button class="text-red-500 text-xs" data-action="delete">Delete</button></td></tr>`).join('');
            document.getElementById('admin-conviviality-body').innerHTML = dataService.getConvivialityQuestions().map(item => `
                <tr data-id="${item.id}" data-type="conviviality"><td><span class="view-mode">${item.question}</span><input type="text" value="${item.question}" class="form-input edit-mode hidden"></td><td><button class="text-blue-500 text-xs mr-2" data-action="edit">Edit</button><button class="text-red-500 text-xs" data-action="delete">Delete</button></td></tr>`).join('');
        };

        // --- EVENT LISTENERS ---
        document.addEventListener('click', (e) => {
            const navLink = e.target.closest('.nav-link');
            if (navLink) {
                e.preventDefault();
                const pageId = navLink.getAttribute('href').substring(1) + '-page';
                showPage(pageId);
            }
            if (e.target.closest('#home-logo')) {
                showPage('main-content');
            }
        });

        document.getElementById('admin-login-link').addEventListener('click', (e) => {
            e.preventDefault();
            showPage('admin-login-page');
        });

        adminLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('admin-login-error');
            if (email === 'admin@cos.com' && password === 'password') {
                errorEl.classList.add('hidden');
                showPage('admin-dashboard-page');
            } else {
                errorEl.classList.remove('hidden');
            }
        });
        
        adminDashboardContainer.addEventListener('click', (e) => {
            const target = e.target;
            const action = target.dataset.action;
            const row = target.closest('tr');
            if (!row && !(action === 'add-feature' || action === 'remove-feature')) return;

            const id = row?.dataset.id;
            const type = row?.dataset.type;

            if (action === 'edit') {
                row.querySelectorAll('.view-mode').forEach(el => el.classList.add('hidden'));
                row.querySelectorAll('.edit-mode').forEach(el => el.classList.remove('hidden'));
                target.textContent = 'Save';
                target.dataset.action = 'save';
                // Hide 'add' dropdown if no options
                if(type === 'technology'){
                    const select = row.querySelector('.add-feature-container select');
                    if (select && select.options.length === 0) {
                        row.querySelector('.add-feature-container').classList.add('hidden');
                    }
                }
            } else if (action === 'save') {
                if (type === 'function') {
                    const newName = row.querySelector('input[type="text"]').value;
                    const newColor = row.querySelector('input[type="color"]').value;
                    dataService.updateFunction(id, newName, newColor);
                } else if (type === 'technology') {
                    const newName = row.querySelector('input[type="text"]').value;
                    const featureList = row.querySelector('.edit-mode-features-list');
                    const featureIds = Array.from(featureList.children).map(child => child.dataset.featureId);
                    dataService.updateTechnology(id, newName, featureIds);
                } else if (type === 'feature') {
                     const newName = row.querySelector('input[type="text"]').value;
                     const newFunctionId = row.querySelector('select').value;
                     dataService.updateFeature(id, newName, newFunctionId);
                } else {
                     const newValue = row.querySelector('input[type="text"]').value;
                     if (type === 'purpose') dataService.updatePurpose(id, newValue);
                     if (type === 'techproficiency') dataService.updateTechProficiency(id, newValue);
                     if (type === 'conviviality') dataService.updateConvivialityQuestion(id, newValue);
                }
                renderAdminTables();
            } else if (action === 'delete') {
                if (confirm('Are you sure you want to delete this item?')) {
                    if (type === 'function') dataService.deleteFunction(id);
                    if (type === 'feature') dataService.deleteFeature(id);
                    if (type === 'technology') dataService.deleteTechnology(id);
                    if (type === 'purpose') dataService.deletePurpose(id);
                    if (type === 'techproficiency') dataService.deleteTechProficiency(id);
                    if (type === 'conviviality') dataService.deleteConvivialityQuestion(id);
                    renderAdminTables();
                }
            } else if (action === 'add-feature') {
                const techRow = target.closest('tr');
                const select = target.previousElementSibling;
                const featureId = select.value;
                if (!featureId) return;
                const feature = dataService.getFeatureById(featureId);
                const list = techRow.querySelector('.edit-mode-features-list');
                const newItem = document.createElement('div');
                newItem.className = 'edit-mode-item';
                newItem.dataset.featureId = featureId;
                newItem.innerHTML = `<span>${feature.name}</span><button class="text-red-500 text-xs" data-action="remove-feature">&times;</button>`;
                list.appendChild(newItem);
                select.remove(select.selectedIndex);
                if (select.options.length === 0) {
                    techRow.querySelector('.add-feature-container').classList.add('hidden');
                }
            } else if (action === 'remove-feature') {
                const techRow = target.closest('tr');
                const item = target.closest('.edit-mode-item');
                const featureId = item.dataset.featureId;
                const feature = dataService.getFeatureById(featureId);
                const select = techRow.querySelector('.edit-mode select');
                const newOption = document.createElement('option');
                newOption.value = featureId;
                newOption.textContent = feature.name;
                select.appendChild(newOption);
                techRow.querySelector('.add-feature-container').classList.remove('hidden');
                item.remove();
            }
        });

        adminDashboardContainer.addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const input = form.querySelector('input');
            const name = input.value.trim();
            if (!name) return;

            if (form.id === 'add-function-form') dataService.addFunction(name);
            if (form.id === 'add-feature-form') {
                const functionId = form.querySelector('select').value;
                dataService.addFeature(name, functionId);
            }
            if (form.id === 'add-technology-form') dataService.addTechnology(name);
            if (form.id === 'add-purpose-form') dataService.addPurpose(name);
            if (form.id === 'add-techproficiency-form') dataService.addTechProficiency(name);
            if (form.id === 'add-conviviality-form') dataService.addConvivialityQuestion(name);
            
            input.value = '';
            renderAdminTables();
        });
        
        assembleFeaturesContainer.addEventListener('change', () => {
            const selectedCheckboxes = assembleFeaturesContainer.querySelectorAll('input[type="checkbox"]:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            renderAssembleResults(selectedIds);
        });

        newTechnologyInput.addEventListener('keypress', (e) => {
             if (e.key === 'Enter' && newTechnologyInput.value.trim() !== '') {
                e.preventDefault();
                const newTech = dataService.addTechnology(newTechnologyInput.value.trim());
                renderEvaluateView();
                evaluateTechSelect.value = newTech.id;
                newTechnologyInput.value = '';
            }
        });
        
        evaluateFeaturesSearch.addEventListener('keyup', (e) => {
            renderEvaluateFeatures(e.target.value);
        });
        
        newPurposeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && newPurposeInput.value.trim() !== '') {
                e.preventDefault();
                dataService.addPurpose(newPurposeInput.value.trim());
                renderEvaluatePurposes();
                newPurposeInput.value = '';
            }
        });
        
        saveEvaluationButton.addEventListener('click', () => {
            const techId = parseInt(evaluateTechSelect.value);
            if (!techId) {
                alert('Please select a technology to evaluate.');
                return;
            }
            const technology = dataService.getTechnologyById(techId);
            
            const convSliders = convivialitySlidersContainer.querySelectorAll('input[type="range"]');
            const totalConvScore = Array.from(convSliders).reduce((sum, slider) => sum + parseInt(slider.value), 0);
            const avgConvScore = totalConvScore / convSliders.length;

            const newEvaluation = {
                techProficiency: parseInt(evaluateTechProficiency.value),
                convivialityScore: avgConvScore,
                comment: evaluationComment.value,
                features: Array.from(document.getElementById('evaluate-features-container').querySelectorAll('input:checked')).map(cb => cb.value),
                purposes: Array.from(document.getElementById('evaluate-purposes-container').querySelectorAll('input:checked')).map(cb => cb.value),
            };
            
            dataService.addEvaluation(techId, newEvaluation);
            dataService.incrementVersion();
            updateVersionTracker();
            
            saveConfirmationMessage.textContent = `Your evaluation of ${technology.name} has been saved.`;
            saveConfirmationMessage.classList.remove('hidden');
setTimeout(() => saveConfirmationMessage.classList.add('hidden'), 3000);

            // Clear form
            const form = document.getElementById('evaluate-form-container');
            form.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
            form.querySelectorAll('textarea, input[type="search"]').forEach(t => t.value = '');
            renderEvaluateFeatures();
            renderEvaluatePurposes();
        });
        
        const handleCommentToggle = (event) => {
            const button = event.target.closest('.tech-name-button');
            if (button) {
                const techId = button.dataset.techId;
                const view = event.currentTarget.dataset.view;
                const commentsContainer = document.getElementById(`comments-${view}-${techId}`);
                const caret = button.querySelector('.caret');
                
                commentsContainer.classList.toggle('hidden');
                caret.classList.toggle('caret-open');

                if (!commentsContainer.classList.contains('hidden')) {
                     const technology = dataService.getTechnologyById(parseInt(techId));
                     const aggData = getAggregateData(technology);
                     
                     let featuresHTML = '<p class="font-semibold">Supported Features:</p>';
                     if (aggData.features.length > 0) {
                         const featureList = aggData.features.map(fid => {
                            const feature = dataService.getFeatureById(fid);
                            return `<li>${feature ? feature.name : 'Unknown feature'}</li>`;
                         }).join('');
                         featuresHTML += `<ul class="list-disc list-inside">${featureList}</ul>`;
                     } else {
                         featuresHTML += '<p>No features listed.</p>';
                     }

                     let commentsHTML = '<p class="font-semibold mt-2">Comments:</p>';
                     const comments = technology.evaluations.filter(ev => ev.comment && ev.comment.trim() !== '' && !ev.isAdminAssigned);
                     if (comments.length > 0) {
                        commentsHTML += comments.map(ev => `<p class="border-t pt-2 mt-2">"${ev.comment}"</p>`).join('');
                     } else {
                        commentsHTML += '<p class="pt-2 mt-2 border-t">No comments yet.</p>';
                     }

                     commentsContainer.innerHTML = featuresHTML + commentsHTML;
                }
            }
        };

        assembleResultsContainer.dataset.view = 'assemble';
        technologiesListContainer.dataset.view = 'technologies';
        assembleResultsContainer.addEventListener('click', handleCommentToggle);
        technologiesListContainer.addEventListener('click', handleCommentToggle);
        
        // --- ROUTING & INITIALIZATION ---
        const handleRouting = () => {
            const hash = window.location.hash || '#';
            const pageId = hash.substring(1) ? hash.substring(1) + '-page' : 'main-content';
            showPage(pageId);
        };

        window.addEventListener('hashchange', handleRouting);
        handleRouting(); // Initial page load
        updateVersionTracker();
    });
    </script>
</body>
</html>