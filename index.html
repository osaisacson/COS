<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convivial Operating Stack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Replaced Permanent Marker with Reenie Beanie for Shrigley vibe -->
    <link href="https://fonts.googleapis.com/css2?family=Reenie+Beanie&family=Space+Grotesk:wght@300;400;500;600;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --border-width: 3px;
            --shadow-offset: 4px;
            --radius: 6px;
        }

        body { 
            background-color: #fffaf0; /* Slightly warm paper tone */
            font-family: 'Inter', sans-serif; 
            color: #000;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: -0.02em;
        }

        /* Neobrutalist Utils */
        .neo-border {
            border: var(--border-width) solid #000;
        }
        .neo-shadow {
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0px 0px #000;
        }
        .neo-shadow-hover:hover {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px 0px #000;
        }
        .neo-card {
            background: white;
            border: var(--border-width) solid #000;
            border-radius: var(--radius);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0px 0px #000;
            transition: all 0.2s ease;
        }
        .neo-card:hover {
            box-shadow: 6px 6px 0px 0px #000;
            transform: translate(-1px, -1px);
        }

        /* Inputs */
        .form-input { 
            border: var(--border-width) solid #000; 
            border-radius: var(--radius); 
            padding: 0.75rem 1rem; 
            width: 100%; 
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            background-color: #fff;
            box-shadow: 2px 2px 0px 0px #ccc;
            transition: all 0.2s;
        }
        .form-input:focus { 
            outline: none; 
            border-color: #000;
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0px 0px #000; 
        }

        /* Buttons */
        .action-button { 
            background-color: #fff; 
            color: #000; 
            font-family: 'Space Mono', monospace;
            font-weight: 700; 
            text-transform: uppercase;
            padding: 0.75rem 1.5rem; 
            border: var(--border-width) solid #000;
            border-radius: var(--radius);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0px 0px #000;
            transition: all 0.1s;
            display: inline-block; 
            text-align: center; 
            cursor: pointer; 
        }
        .action-button:hover { 
            background-color: #f0f0f0;
            transform: translate(2px, 2px); 
            box-shadow: 2px 2px 0px 0px #000; 
        }
        .action-button.primary {
            background-color: #000;
            color: #fff;
        }
        .action-button.primary:hover {
            background-color: #222;
        }

        /* Custom Checkboxes */
        .feature-checkbox { 
            appearance: none;
            width: 1.25rem; 
            height: 1.25rem; 
            border: 2px solid #000;
            border-radius: 2px;
            margin-top: 2px;
            display: grid;
            place-content: center;
            cursor: pointer;
        }
        .feature-checkbox::before {
            content: "";
            width: 0.75rem;
            height: 0.75rem;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #000; /* Checkmark color */
        }
        .feature-checkbox:checked::before {
            transform: scale(1);
        }
        
        /* Sliders */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { 
            width: 100%; height: 12px; cursor: pointer; 
            background: #fff; border: 2px solid #000; border-radius: 999px; 
        }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            height: 24px; width: 24px; 
            border: 2px solid #000;
            border-radius: 50%; 
            background: #000; 
            cursor: pointer; 
            margin-top: -8px; /* Center thumb on track */
            box-shadow: 2px 2px 0px 0px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }

        .tech-name-button { cursor: pointer; user-select: none; }
        .tech-name-button:hover { text-decoration: underline; text-decoration-thickness: 2px; }
        .caret { transition: transform 0.2s ease-in-out; display: inline-block; margin-right: 0.5rem; font-weight: bold; }
        .caret-open { transform: rotate(90deg); }
        .page-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page-content.active { display: block; }
        
        /* Admin Table */
        .admin-table { 
            width: 100%; border-collapse: separate; border-spacing: 0; 
            border: var(--border-width) solid #000; 
            border-radius: var(--radius); 
            overflow: hidden; 
        }
        .admin-table th, .admin-table td { 
            padding: 12px; text-align: left; 
            font-size: 0.9rem; font-family: 'Space Mono', monospace;
            vertical-align: middle; 
            border-bottom: 2px solid #000; 
        }
        .admin-table th { 
            background-color: #000; 
            font-weight: 700; 
            color: #fff; 
            text-transform: uppercase;
        }
        .admin-table tr:last-child td { border-bottom: none; }
        .admin-table tr:hover td { background-color: #fffce8; }
        
        .slider-container { 
            padding: 1rem; 
            background-color: #fff; 
            border: 2px solid #000; 
            border-radius: var(--radius); 
            box-shadow: 3px 3px 0px 0px #000;
            margin-bottom: 1.5rem; 
        }
        .slider-label { 
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem; color: #000; 
            font-weight: 700; text-transform: uppercase; 
            margin-bottom: 0.5rem; display: block; 
        }
        .slider-value-display { 
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1rem; font-weight: 700; color: #000; margin-top: 0.5rem; 
        }
        
        /* Logo Styles */
        .logo-bubble { 
            position: absolute; border-radius: 50%; 
            mix-blend-mode: normal; /* Better for borders */
            opacity: 0.9; 
            border: 2px solid #000;
            transition: all 0.3s ease; 
        }
        .logo-bubble:hover { transform: scale(1.1); z-index: 10; cursor: pointer; }

        .handwriting-font {
            font-family: 'Reenie Beanie', cursive;
            font-weight: 400;
        }

        .tag {
            display: inline-block;
            border: 2px solid #000;
            padding: 2px 6px;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 0.7rem;
            border-radius: 4px;
            text-transform: uppercase;
            box-shadow: 2px 2px 0px 0px #000;
        }

        .new-flag { background-color: #22c55e; color: black; border-color: black; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-black antialiased min-h-screen flex flex-col selection:bg-black selection:text-white">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl flex-grow">
        <header class="flex flex-col md:flex-row justify-between items-center py-6 mb-8 border-b-4 border-black">
            <div id="home-logo" class="h-20 w-20 relative cursor-pointer mb-4 md:mb-0" title="Functions scaled by feature count">
                <!-- SVG/Bubbles injected by JS -->
            </div>
            <nav class="flex flex-wrap justify-center space-x-6 font-bold text-black font-['Space_Mono'] uppercase tracking-tight">
                <a href="#technologies" class="nav-link hover:underline decoration-2 underline-offset-4">All technologies</a>
            </nav>
        </header>

        <main id="main-content" class="page-content active">
            <!-- 1. Hero Section -->
            <section id="hero-section">
                <div class="grid md:grid-cols-2 gap-12 py-12 items-center">
                    <div class="flex flex-col justify-center">
                        <h1 class="text-6xl md:text-7xl font-bold leading-none tracking-tighter text-black mb-6">
                            CONVIVIAL<br>OPERATING<br>STACK
                        </h1>
                        <div class="border-l-4 border-black pl-6 py-2">
                            <p class="text-xl md:text-2xl text-black font-medium font-['Space_Grotesk']">A toolbox of technologies tried and tested by countercultures.</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-center md:justify-end">
                        <div class="transform rotate-[-3deg] bg-white p-6 border-[3px] border-black shadow-[8px_8px_0px_0px_#000]">
                            <!-- Updated font class to Reenie Beanie -->
                            <p class="text-5xl md:text-6xl text-black handwriting-font leading-none text-center transform rotate-3 pt-2">
                                the more we<br>share the more<br>we have
                            </p>
                        </div>
                    </div>
                </div>
                <div class="text-black space-y-4 text-lg border-t-4 border-black pt-12 mt-4 max-w-4xl">
                     <p>The COS is a continously evolving toolbox of what various post-growth groups are using as technological infrastructure. It supports methodological luddism - helping to choose what technologies you actually need, and what you <strong>don't</strong> need.</p>
                     
                     <div class="flex flex-col md:flex-row gap-6 items-center pt-8">
                        <a href="#assemble" class="action-button primary text-xl px-8 py-4">Assemble your Stack</a>
                        <span class="text-black italic font-serif text-lg">or</span>
                        <a href="#evaluate" class="action-button text-lg px-8 py-4">Evaluate Tools</a>
                        <span id="version-tracker" class="tag bg-yellow-400"></span>
                     </div>
                </div>
            </section>
        </main>

        <!-- 5a. Assemble COS Page -->
        <section id="assemble-page" class="page-content">
            <h2 class="text-4xl font-bold mb-8 uppercase border-b-4 border-black inline-block pb-2">Assemble your Stack</h2>
            <div class="grid md:grid-cols-12 gap-12 relative">
                <!-- Sidebar -->
                <div class="md:col-span-5 lg:col-span-4">
                    <div class="sticky top-4 space-y-6">
                        <div class="bg-black text-white p-2 font-['Space_Mono'] font-bold uppercase text-center border-2 border-black">Parameters</div>
                        
                        <div class="slider-container">
                            <label class="slider-label">Technology knowledge</label>
                            <input type="range" id="assemble-tech-slider" min="1" max="5" step="1" value="3">
                            <div id="assemble-tech-display" class="slider-value-display">Comfortable with new software</div>
                        </div>
                        <div class="slider-container">
                            <label class="slider-label">Group Size</label>
                            <input type="range" id="assemble-size-slider" min="1" max="5" step="1" value="2">
                            <div id="assemble-size-display" class="slider-value-display">Smallish Group (6-15)</div>
                        </div>
                        <div class="p-4 bg-teal-100 border-[3px] border-black rounded-md shadow-[4px_4px_0px_0px_#000]">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="assemble-floss-filter" class="feature-checkbox bg-white">
                                <span class="font-bold text-black font-['Space_Mono'] uppercase">Strictly Open Source</span>
                            </label>
                        </div>

                        <div class="mt-8">
                            <div class="bg-black text-white p-2 font-['Space_Mono'] font-bold uppercase text-center border-2 border-black mb-4">Features Needed</div>
                            <div id="assemble-features-container" class="space-y-2 max-h-[50vh] overflow-y-auto pr-2 custom-scrollbar"></div>
                        </div>
                    </div>
                </div>
                <!-- Results -->
                <div class="md:col-span-7 lg:col-span-8">
                    <div class="flex items-center justify-between mb-6">
                         <h3 class="text-xl font-bold font-['Space_Mono'] uppercase">Recommended Stack</h3>
                    </div>
                    <div id="assemble-results-container" class="space-y-8"></div>
                </div>
            </div>
        </section>

        <!-- 5b. Evaluate Technologies Page -->
        <section id="evaluate-page" class="page-content">
             <div class="max-w-3xl mx-auto">
                <div class="border-l-4 border-black pl-6 mb-8">
                    <h2 class="text-4xl font-bold uppercase">Evaluation</h2>
                    <p class="text-gray-600 font-['Space_Mono'] mt-2">Share your experience of specific technologies.</p>
                </div>
                
                <div id="evaluate-form-container" class="space-y-8 bg-white p-8 border-[3px] border-black shadow-[8px_8px_0px_0px_#000]">
                    <div>
                        <label class="block text-sm font-bold font-['Space_Mono'] uppercase mb-2">Technology</label>
                        <select id="evaluate-tech-select" class="form-input"></select>
                        <input type="text" id="new-technology-input" class="form-input mt-4" placeholder="Or type new tech + Enter...">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div class="slider-container mb-0 shadow-none">
                            <label class="slider-label">Needed tech knowledge</label>
                            <input type="range" id="evaluate-tech-slider" min="1" max="5" step="1" value="3">
                            <div id="evaluate-tech-display" class="slider-value-display text-center text-purple-600">Comfortable with new software</div>
                        </div>
                        <div class="slider-container mb-0 shadow-none">
                            <label class="slider-label">Used for group size</label>
                            <input type="range" id="evaluate-size-slider" min="1" max="5" step="1" value="2">
                            <div id="evaluate-size-display" class="slider-value-display text-center text-purple-600">Smallish Group (6-15)</div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold font-['Space_Mono'] uppercase mb-2">What does it help with?</label>
                        <input type="search" id="evaluate-features-search" class="form-input mb-4" placeholder="Search features...">
                        <div id="evaluate-features-container" class="p-4 border-[2px] border-black bg-gray-50 max-h-48 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-2"></div>
                    </div>
                    
                    <div id="conviviality-questions" class="pt-6 border-t-4 border-black">
                         <div class="flex justify-between items-baseline mb-6">
                            <label class="text-lg font-bold uppercase bg-black text-white px-2 py-1">Conviviality Score</label>
                            <span class="text-xs font-['Space_Mono'] border border-black px-2 py-1 bg-white">Ref: Vetter (2018)</span>
                         </div>
                         <div id="conviviality-sliders-container" class="space-y-6"></div>
                    </div>
                    
                    <div class="pt-4 border-t-4 border-black">
                        <label class="block text-sm font-bold font-['Space_Mono'] uppercase mb-2 mt-4">Comments</label>
                        <textarea id="evaluation-comment" class="form-input" rows="3" placeholder="Your review..."></textarea>
                    </div>

                    <div class="pt-6">
                        <button id="save-evaluation-button" class="action-button primary w-full text-lg py-4">Submit Evaluation</button>
                        <p id="save-error-message" class="text-sm font-bold text-red-600 mt-4 hidden bg-red-100 p-2 border-2 border-red-600 text-center"></p>
                        <p id="save-confirmation-message" class="text-sm font-bold text-green-700 mt-4 hidden bg-green-100 p-2 border-2 border-green-700 flex justify-center items-center">
                            <span>EVALUATION SAVED.</span>
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <section id="technologies-page" class="page-content">
             <h2 class="text-4xl font-bold mb-8 uppercase border-b-4 border-black inline-block pb-2">Technologies</h2>
             <div id="technologies-list-container" class="space-y-6"></div>
        </section>

        <section id="admin-login-page" class="page-content">
            <div class="max-w-md mx-auto mt-12 bg-white p-8 border-[3px] border-black shadow-[8px_8px_0px_0px_#000]">
                <h2 class="text-3xl font-bold mb-8 text-center uppercase">Admin Login</h2>
                <form id="admin-login-form" class="space-y-6">
                    <div>
                        <label for="admin-email" class="block text-sm font-bold font-['Space_Mono'] uppercase mb-2">Email</label>
                        <input type="email" id="admin-email" class="form-input" value="admin@cos.com">
                    </div>
                    <div>
                        <label for="admin-password" class="block text-sm font-bold font-['Space_Mono'] uppercase mb-2">Password</label>
                        <input type="password" id="admin-password" class="form-input" value="password">
                    </div>
                    <p id="admin-login-error" class="text-red-600 font-bold text-sm hidden bg-red-100 p-2 border-2 border-red-600">Invalid credentials.</p>
                    <button type="submit" class="action-button w-full">Login</button>
                    <p class="text-xs text-center font-['Space_Mono'] text-gray-500 mt-4">Hint: Use pre-filled credentials</p>
                </form>
            </div>
        </section>
        
        <section id="admin-dashboard-page" class="page-content">
            <div class="flex justify-between items-end mb-8 border-b-4 border-black pb-4">
                <h2 class="text-3xl font-bold uppercase">Admin Dashboard</h2>
                <button id="admin-logout" class="text-sm font-bold text-red-600 hover:text-white hover:bg-red-600 px-2 py-1 border-2 border-red-600 transition-colors uppercase">Logout</button>
            </div>
            <div id="admin-dashboard-container" class="space-y-16"></div>
        </section>

        <footer class="text-right py-8 mt-16 border-t-4 border-black">
            <div class="container mx-auto px-4">
                <a href="#admin-login" id="admin-login-link" class="nav-link text-xs font-bold font-['Space_Mono'] text-gray-400 hover:text-black uppercase">Admin Access</a>
            </div>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA ---
        const appData = {
            version: 1.8,
            // Colors: Magenta, Purple, Teal, Yellow
            functions: [
                { id: 'commons', name: 'Collaborative Commons', color: '#ec4899', accent: 'accent-pink-500' }, // Vibrant Pink (pink-500)
                { id: 'admin', name: 'Assisted Administration', color: '#9333ea', accent: 'accent-purple-600' }, // Purple (purple-600)
                { id: 'production', name: 'Peer Production', color: '#0d9488', accent: 'accent-teal-600' }, // Teal (teal-600)
                { id: 'economy', name: 'Egalitarian Economy', color: '#eab308', accent: 'accent-yellow-500' }, // Stronger Yellow (yellow-500)
            ],
            // Features mapped to the new 4 functions
            features: [
                // Collaborative Commons (Communication, Decisions, Knowledge, Connection)
                {id: 'f1', name: 'Find and connect with others', functionId: 'commons'},
                {id: 'f2', name: 'Communicate around projects', functionId: 'commons'},
                {id: 'f3', name: 'Brainstorm ideas together', functionId: 'commons'},
                {id: 'f9', name: 'Build a shared knowledge base', functionId: 'commons'},
                {id: 'f_save', name: 'Save web content for later', functionId: 'commons'},
                {id: 'f_blog', name: 'Publish news or a blog', functionId: 'commons'},
                {id: 'f_event', name: 'Organize events', functionId: 'commons'},
                {id: 'f_plan1', name: 'Agree on meeting dates', functionId: 'commons'},
                {id: 'f_decide', name: 'Make collective decisions', functionId: 'commons'},
                {id: 'f_map', name: 'Create mind maps', functionId: 'commons'},

                // Assisted Administration (Org, Tasks, Forms)
                {id: 'f6', name: 'Track tasks and projects', functionId: 'admin'},
                {id: 'f7', name: 'Store and organize documents', functionId: 'admin'},
                {id: 'f10', name: 'Distribute admin tasks', functionId: 'admin'},
                {id: 'f11', name: 'Gather information (Forms)', functionId: 'admin'},
                {id: 'f_form', name: 'Create online forms', functionId: 'admin'},
                {id: 'f_kanban', name: 'Visual task boards (Kanban)', functionId: 'admin'},

                // Peer Production (Making things: Code, Design, Text, Resources)
                {id: 'f8', name: 'Book shared resources/tools', functionId: 'production'},
                {id: 'f_write', name: 'Collaborative writing', functionId: 'production'},
                {id: 'f_git', name: 'Host and version code', functionId: 'production'},
                {id: 'f_video', name: 'Host and share videos', functionId: 'production'},
                {id: 'f_3d', name: 'Share 3D designs', functionId: 'production'},

                // Egalitarian Economy (Money, Value)
                {id: 'f4', name: 'Manage shared finances', functionId: 'economy'},
                {id: 'f5', name: 'Create and manage budgets', functionId: 'economy'},
                {id: 'f_calc', name: 'Collaborative spreadsheets', functionId: 'economy'},
                {id: 'f12', name: 'Handle expense reimbursements', functionId: 'economy'},
                {id: 'f13', name: 'Manage membership fees', functionId: 'economy'},
                {id: 'f14', name: 'Funding for events', functionId: 'economy'},
                {id: 'f15', name: 'Receive outside funding', functionId: 'economy'},
            ],
            techProficiencyLevels: [
                { id: 1, name: 'Happy luddites' },
                { id: 2, name: 'Basic technology users' },
                { id: 3, name: 'Comfortable with new software' },
                { id: 4, name: 'Some technology experts' },
                { id: 5, name: 'Able to code' },
            ],
            groupSizes: [
                { id: 1, name: 'Testing out idea (<5)' },
                { id: 2, name: 'Working Group (6-15)' },
                { id: 3, name: 'Community (16-50)' },
                { id: 4, name: 'Network (50-200)' },
                { id: 5, name: 'Movement (200+)' },
            ],
            technologies: [
                { id: 1, name: 'Discord', isOpenSource: false, evaluations: [
                    { techProficiency: 3, groupSize: 4, convivialityScore: 2.5, comment: "Great for quick chats, but can be overwhelming and extractive.", features: ['f1', 'f2'] },
                ]},
                { id: 2, name: 'WhatsApp', isOpenSource: false, evaluations: [
                     { techProficiency: 1, groupSize: 2, convivialityScore: 1.5, comment: "Super easy to use, but owned by Meta. Privacy concerns.", features: ['f1', 'f2'] }
                ]},
                { id: 3, name: 'Open Collective', isOpenSource: true, evaluations: [
                    { techProficiency: 2, groupSize: 3, convivialityScore: 9.2, comment: "A game-changer for transparent finances and reducing admin load.", features: ['f10', 'f11', 'f12', 'f13', 'f14', 'f15', 'f4', 'f5'] }
                ] },
                { id: 4, name: 'Trello', isOpenSource: false, evaluations: [
                    { techProficiency: 2, groupSize: 2, convivialityScore: 3.0, comment: "Visual and intuitive, but proprietary software.", features: ['f6', 'f_kanban'] }
                ]},
                { id: 5, name: 'Facebook', isOpenSource: false, evaluations: [
                    { techProficiency: 4, groupSize: 5, convivialityScore: 1.0, comment: "Feels invasive and constantly tries to sell you things. Hard to control your own data.", features: ['f1', 'f2'] }
                ]},
                // Framasoft Suite
                { id: 6, name: 'Framadate', isOpenSource: true, evaluations: [
                    { techProficiency: 1, groupSize: 2, convivialityScore: 9.8, comment: "Simple, ethical scheduling without ads.", features: ['f_plan1'] }
                ]},
                { id: 7, name: 'Framapad', isOpenSource: true, evaluations: [
                    { techProficiency: 2, groupSize: 2, convivialityScore: 9.5, comment: "Excellent for taking minutes together in real time.", features: ['f_write', 'f3'] }
                ]},
                { id: 8, name: 'Framacalc', isOpenSource: true, evaluations: [
                    { techProficiency: 2, groupSize: 2, convivialityScore: 9.0, comment: "Like Excel but online and collaborative. Very useful.", features: ['f_calc', 'f4', 'f5'] }
                ]},
                { id: 9, name: 'Framavox', isOpenSource: true, evaluations: [
                    { techProficiency: 3, groupSize: 3, convivialityScore: 8.8, comment: "Great for Loomio-style decision making.", features: ['f_decide', 'f3'] }
                ]},
                { id: 10, name: 'Framaforms', isOpenSource: true, evaluations: [
                    { techProficiency: 2, groupSize: 4, convivialityScore: 9.2, comment: "Drag and drop form builder, respectful of privacy.", features: ['f_form', 'f11'] }
                ]},
                { id: 11, name: 'Framamind', isOpenSource: true, evaluations: [
                    { techProficiency: 2, groupSize: 2, convivialityScore: 8.5, comment: "Good for initial brainstorming sessions.", features: ['f_map', 'f3'] }
                ]},
                { id: 12, name: 'Mobilizon', isOpenSource: true, evaluations: [
                    { techProficiency: 3, groupSize: 4, convivialityScore: 9.2, comment: "A powerful alternative to Facebook Events.", features: ['f_event', 'f1', 'f2'] }
                ]},
                { id: 13, name: 'Framagit', isOpenSource: true, evaluations: [
                    { techProficiency: 4, groupSize: 3, convivialityScore: 9.0, comment: "Essential for sharing code and open source projects.", features: ['f_git', 'f7'] }
                ]},
                { id: 14, name: 'Framatalk', isOpenSource: true, evaluations: [
                    { techProficiency: 2, groupSize: 1, convivialityScore: 8.5, comment: "Video conferencing that just works in the browser.", features: ['f2'] }
                ]},
                { id: 15, name: 'Framaspace', isOpenSource: true, evaluations: [
                    { techProficiency: 3, groupSize: 3, convivialityScore: 9.5, comment: "Complete cloud storage and collaboration suite based on Nextcloud.", features: ['f7', 'f2', 'f11'] }
                ]},
                { id: 16, name: 'Framalistes', isOpenSource: true, evaluations: [
                    { techProficiency: 2, groupSize: 4, convivialityScore: 9.0, comment: "Classic email lists for group coordination.", features: ['f2'] }
                ]},
                { id: 17, name: 'Framateam', isOpenSource: true, evaluations: [
                    { techProficiency: 3, groupSize: 3, convivialityScore: 9.0, comment: "Team chat alternative to Slack/Discord.", features: ['f1', 'f2'] }
                ]},
                { id: 18, name: 'Framaboard', isOpenSource: true, evaluations: [
                    { techProficiency: 2, groupSize: 2, convivialityScore: 9.0, comment: "Kanban board for task management. Alternative to Trello.", features: ['f6', 'f_kanban'] }
                ]},
                { id: 19, name: 'Framabag', isOpenSource: true, evaluations: [
                    { techProficiency: 2, groupSize: 1, convivialityScore: 9.2, comment: "Save web pages to read later. Alternative to Pocket.", features: ['f_save', 'f11'] }
                ]},
                { id: 20, name: 'PeerTube', isOpenSource: true, evaluations: [
                    { techProficiency: 4, groupSize: 4, convivialityScore: 9.5, comment: "Decentralized video hosting platform. Alternative to YouTube.", features: ['f_video', 'f7'] }
                ]},
                { id: 21, name: 'Framablog', isOpenSource: true, evaluations: [
                    { techProficiency: 3, groupSize: 3, convivialityScore: 9.0, comment: "Lightweight blog to share news.", features: ['f_blog', 'f1'] }
                ]},
                { id: 22, name: 'Thingiverse', isOpenSource: false, evaluations: [
                    { techProficiency: 3, groupSize: 5, convivialityScore: 4.0, comment: "Massive library of 3D designs, but corporate-owned.", features: ['f_3d'] }
                ]},
                // Added new technologies based on user request
                { id: 23, name: 'Coda', isOpenSource: false, evaluations: [
                    { techProficiency: 3, groupSize: 3, convivialityScore: 4.0, comment: "Powerful, but creates dependency on their platform. Proprietary.", features: ['f7', 'f6', 'f_calc', 'f_form'] }
                ]},
                { id: 24, name: 'Loomio', isOpenSource: true, evaluations: [
                    { techProficiency: 2, groupSize: 4, convivialityScore: 9.5, comment: "The gold standard for asynchronous democratic decision making.", features: ['f_decide', 'f2'] }
                ]},
                { id: 25, name: 'Miro', isOpenSource: false, evaluations: [
                    { techProficiency: 2, groupSize: 3, convivialityScore: 5.0, comment: "Visually great for brainstorming, but proprietary and gets expensive.", features: ['f_map', 'f3'] }
                ]},
                { id: 26, name: 'Slack', isOpenSource: false, evaluations: [
                    { techProficiency: 3, groupSize: 4, convivialityScore: 3.5, comment: "Standard for tech groups, but history disappears on free plan. Addictive.", features: ['f1', 'f2', 'f_git'] }
                ]},
                { id: 27, name: 'Messenger', isOpenSource: false, evaluations: [
                    { techProficiency: 1, groupSize: 2, convivialityScore: 1.5, comment: "Very low conviviality. Conversations get lost in the flow. Data extraction concerns.", features: ['f1', 'f2'] }
                ]}
            ],
            // Modified per Vetter (2018)
            convivialityQuestions: [
                { id: 'relatedness', question: 'Relatedness: Does it help us relate to each other?' },
                { id: 'accessibility', question: 'Accessibility: Can anyone access and understand it?' },
                { id: 'adaptability', question: 'Adaptability: Can we adapt and repair it?' },
                { id: 'biointeraction', question: 'Bio-interaction: Is it ecologically sustainable?' },
                { id: 'appropriateness', question: 'Appropriateness: Does it fit our specific situation?' },
            ]
        };

        const dataService = {
            getVersion: () => appData.version,
            incrementVersion: () => { appData.version = parseFloat((appData.version + 0.1).toFixed(1)); },
            // GETTERS
            getFunctions: () => appData.functions,
            getFeatures: () => appData.features,
            getTechnologies: () => appData.technologies,
            getTechProficiencyLevels: () => appData.techProficiencyLevels,
            getGroupSizes: () => appData.groupSizes,
            getConvivialityQuestions: () => appData.convivialityQuestions,
            getFeaturesByFunction: (functionId) => appData.features.filter(f => f.functionId === functionId),
            getFeatureById: (id) => appData.features.find(f => f.id === id),
            getTechnologyById: (id) => appData.technologies.find(t => t.id === id),
            
            // ADDERS
            addFunction: (name) => {
                const colors = ['#db2777', '#9333ea', '#0d9488', '#ca8a04'];
                const accents = ['accent-pink-600', 'accent-purple-600', 'accent-teal-600', 'accent-yellow-600'];
                const nextColorIndex = appData.functions.length % colors.length;
                const newFunc = { id: `func${Date.now()}`, name, color: colors[nextColorIndex], accent: accents[nextColorIndex] };
                appData.functions.push(newFunc);
                renderLogo(); // Re-render logo on change
            },
            addFeature: (name, functionId) => {
                const newFeature = { id: `f${Date.now()}`, name, functionId, isNew: true };
                appData.features.push(newFeature);
                renderLogo(); // Re-render logo on change
            },
            addTechnology: (name) => {
                const newTech = { id: Date.now(), name, evaluations: [] };
                appData.technologies.push(newTech);
                return newTech;
            },
            addEvaluation: (techId, evaluationData) => {
                const tech = dataService.getTechnologyById(techId);
                if (tech) tech.evaluations.push(evaluationData);
            },
             addTechProficiency: (name) => {
                const maxLevel = Math.max(0, ...appData.techProficiencyLevels.map(l => l.id));
                appData.techProficiencyLevels.push({ id: maxLevel + 1, name });
            },
            addConvivialityQuestion: (question) => {
                appData.convivialityQuestions.push({ id: `conv${Date.now()}`, question });
            },
            
            // UPDATERS
            updateFunction: (id, newName, newColor) => {
                const func = appData.functions.find(f => f.id == id);
                if (func) {
                    func.name = newName;
                    func.color = newColor;
                }
            },
            updateFeature: (id, newName, newFunctionId) => {
                const feature = appData.features.find(f => f.id == id);
                if (feature) {
                    feature.name = newName;
                    feature.functionId = newFunctionId;
                }
                renderLogo(); // Re-render logo on change
            },
            updateTechnology: (id, newName, featureIds) => {
                const tech = appData.technologies.find(t => t.id == id);
                if (tech) {
                    tech.name = newName;
                    let adminEval = tech.evaluations.find(ev => ev.isAdminAssigned);
                    if (adminEval) {
                        adminEval.features = featureIds;
                    } else {
                        tech.evaluations.push({ 
                            features: featureIds, 
                            isAdminAssigned: true,
                            comment: "Admin-assigned features.", 
                            convivialityScore: 0, 
                            techProficiency: 0, 
                            groupSize: 1
                        });
                    }
                }
            },
            updateTechProficiency: (id, newName) => {
                const item = appData.techProficiencyLevels.find(l => l.id == id);
                if (item) item.name = newName;
            },
            updateConvivialityQuestion: (id, newQuestion) => {
                const item = appData.convivialityQuestions.find(q => q.id == id);
                if (item) item.question = newQuestion;
            },

            // DELETERS
            deleteFunction: (id) => {
                appData.functions = appData.functions.filter(f => f.id != id);
                appData.features = appData.features.filter(f => f.functionId != id);
                renderLogo(); // Re-render logo on change
            },
            deleteFeature: (id) => {
                appData.features = appData.features.filter(f => f.id != id);
                renderLogo(); // Re-render logo on change
            },
            deleteTechnology: (id) => {
                appData.technologies = appData.technologies.filter(t => t.id != id);
            },
            deleteTechProficiency: (id) => {
                appData.techProficiencyLevels = appData.techProficiencyLevels.filter(l => l.id != id);
            },
             deleteConvivialityQuestion: (id) => {
                appData.convivialityQuestions = appData.convivialityQuestions.filter(q => q.id != id);
            }
        };

        // --- ELEMENTS ---
        const pageContents = document.querySelectorAll('.page-content');
        const homeLogo = document.getElementById('home-logo');
        const technologiesListContainer = document.getElementById('technologies-list-container');
        const assembleFeaturesContainer = document.getElementById('assemble-features-container');
        const assembleResultsContainer = document.getElementById('assemble-results-container');
        const evaluateTechSelect = document.getElementById('evaluate-tech-select');
        const newTechnologyInput = document.getElementById('new-technology-input');
        const evaluateTechProficiency = document.getElementById('evaluate-tech-proficiency');
        const evaluateFeaturesSearch = document.getElementById('evaluate-features-search');
        const evaluateFeaturesContainer = document.getElementById('evaluate-features-container');
        const saveEvaluationButton = document.getElementById('save-evaluation-button');
        const evaluationComment = document.getElementById('evaluation-comment');
        const convivialitySlidersContainer = document.getElementById('conviviality-sliders-container');
        const saveConfirmationMessage = document.getElementById('save-confirmation-message');
        const saveErrorMessage = document.getElementById('save-error-message');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminDashboardContainer = document.getElementById('admin-dashboard-container');
        const versionTracker = document.getElementById('version-tracker');

        // New Slider Elements
        const assembleTechSlider = document.getElementById('assemble-tech-slider');
        const assembleSizeSlider = document.getElementById('assemble-size-slider');
        const assembleTechDisplay = document.getElementById('assemble-tech-display');
        const assembleSizeDisplay = document.getElementById('assemble-size-display');
        
        const evaluateTechSlider = document.getElementById('evaluate-tech-slider');
        const evaluateSizeSlider = document.getElementById('evaluate-size-slider');
        const evaluateTechDisplay = document.getElementById('evaluate-tech-display');
        const evaluateSizeDisplay = document.getElementById('evaluate-size-display');
        
        const assembleFlossFilter = document.getElementById('assemble-floss-filter');


        // --- HELPERS ---
        const getAggregateData = (technology) => {
            const adminEval = technology.evaluations.find(ev => ev.isAdminAssigned);
            const userEvals = technology.evaluations.filter(ev => !ev.isAdminAssigned);

            const features = adminEval ? adminEval.features : [...new Set(userEvals.flatMap(ev => ev.features))];
            
            const functionIds = [...new Set(features.map(featureId => {
                const feature = dataService.getFeatureById(featureId);
                return feature ? feature.functionId : null;
            }).filter(Boolean))];

            if (userEvals.length === 0) {
                 return { conviviality: null, proficiency: null, groupSize: null, features, functionIds };
            }

            const totalConv = userEvals.reduce((sum, ev) => sum + ev.convivialityScore, 0);
            const totalProf = userEvals.reduce((sum, ev) => sum + ev.techProficiency, 0);
            const totalSize = userEvals.reduce((sum, ev) => sum + (ev.groupSize || 2), 0); // Default to 2 if undefined

            return {
                conviviality: totalConv / userEvals.length,
                proficiency: totalProf / userEvals.length,
                groupSize: totalSize / userEvals.length,
                features,
                functionIds
            };
        };
        
        const getScoreColor = (score, type) => {
            if (score === null) return 'text-gray-400';
            if (type === 'conviviality') {
                if (score >= 7) return 'text-green-600';
                else if (score >= 4) return 'text-yellow-600';
                else return 'text-red-600';
            } else if (type === 'tech') {
                if (score >= 4) return 'text-red-600';
                else if (score >= 2.5) return 'text-yellow-600';
                else return 'text-green-600';
            }
            return 'text-gray-700';
        };

        const updateSliderDisplay = (slider, display, type) => {
            const val = parseInt(slider.value);
            if (type === 'tech') {
                const level = dataService.getTechProficiencyLevels().find(l => l.id === val);
                display.textContent = level ? level.name : '';
            } else {
                const level = dataService.getGroupSizes().find(l => l.id === val);
                display.textContent = level ? level.name : '';
            }
        };

        const renderLogo = () => {
            const container = document.getElementById('home-logo');
            if (!container) return;
            container.innerHTML = '';
            
            const funcs = dataService.getFunctions();
            // Count features per function
            const counts = funcs.map(func => {
                const count = dataService.getFeaturesByFunction(func.id).length;
                return { ...func, count: Math.max(count, 1) }; // Min size 1
            });
            
            // Venn Diagram Logic (Simplified for CSS)
            // We place them in a circle
            const radius = 25; // radius of the circle of centers
            const center = 50; // center of container (percentage)
            
            counts.forEach((func, index) => {
                const angle = (index / counts.length) * 2 * Math.PI;
                const x = center + radius * Math.cos(angle);
                const y = center + radius * Math.sin(angle);
                
                // Scale bubble size based on feature count
                // Base size 30%, max additional based on count relative to total
                const size = 30 + (func.count * 2.5); 
                
                const bubble = document.createElement('div');
                bubble.className = 'logo-bubble shadow-sm';
                bubble.style.backgroundColor = func.color;
                bubble.style.left = `${x}%`;
                bubble.style.top = `${y}%`;
                bubble.style.width = `${size}%`;
                bubble.style.height = `${size}%`;
                bubble.style.transform = 'translate(-50%, -50%)'; // Center on coordinate
                bubble.title = `${func.name}: ${func.count} features`;
                
                container.appendChild(bubble);
            });
        };

        // --- STATE MANAGEMENT ---
        const showPage = (pageId) => {
            // Fade out current active
            const current = document.querySelector('.page-content.active');
            if(current && current.id !== pageId) {
                current.classList.remove('active');
            }
            
            // Activate new page
            pageContents.forEach(page => {
                if (page.id === pageId) {
                    page.classList.add('active');
                    window.scrollTo(0,0);
                    
                    if(page.id === 'assemble-page') {
                        renderAssembleView();
                        const selectedCheckboxes = assembleFeaturesContainer.querySelectorAll('input[type="checkbox"]:checked');
                        const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
                        renderAssembleResults(selectedIds);
                    }
                    if(page.id === 'evaluate-page') {
                        renderEvaluateView();
                    }
                    if(page.id === 'technologies-page') {
                        renderTechnologiesList(technologiesListContainer, 'technologies');
                    }
                    if(page.id === 'admin-dashboard-page') {
                        renderAdminDashboard();
                    }
                }
            });
        };
        
        // --- RENDER FUNCTIONS ---
        const updateVersionTracker = () => {
            versionTracker.textContent = `v${dataService.getVersion().toFixed(1)}`;
        };

        const renderConvivialitySliders = () => {
            convivialitySlidersContainer.innerHTML = dataService.getConvivialityQuestions().map(q => `
                <div>
                    <div class="flex justify-between mb-1 items-end">
                        <label class="text-sm font-bold font-['Space_Mono'] uppercase max-w-[80%]">${q.question}</label>
                        <span class="text-lg font-bold bg-black text-white px-2 rounded-sm" id="val-${q.id}">5</span>
                    </div>
                    <input type="range" min="1" max="10" value="5" class="w-full" data-conv-id="${q.id}" oninput="document.getElementById('val-${q.id}').textContent = this.value">
                    <div class="flex justify-between text-xs font-['Space_Mono'] text-gray-500 mt-1 uppercase">
                        <span>Low</span>
                        <span>High</span>
                    </div>
                </div>
            `).join('');
        };
        
        const renderAssembleView = () => {
            // Update labels based on current slider values
            updateSliderDisplay(assembleTechSlider, assembleTechDisplay, 'tech');
            updateSliderDisplay(assembleSizeSlider, assembleSizeDisplay, 'size');

            const allFeatures = dataService.getFeatures();
            const existingContainer = document.getElementById('assemble-features-container');
            const checkedIds = Array.from(existingContainer.querySelectorAll('input:checked')).map(cb => cb.value);

            assembleFeaturesContainer.innerHTML = allFeatures.map(feat => {
                const newFlag = feat.isNew ? '<span class="tag new-flag ml-2">new</span>' : '';
                const isChecked = checkedIds.includes(feat.id) ? 'checked' : '';
                return `
                    <label class="flex items-center space-x-3 cursor-pointer p-2 hover:bg-yellow-50 transition-colors border-b border-gray-200 last:border-0 group">
                        <input type="checkbox" value="${feat.id}" class="feature-checkbox" ${isChecked}>
                        <div class="text-sm font-['Inter'] font-medium group-hover:text-black transition-colors">
                            ${feat.name}
                            ${newFlag}
                        </div>
                    </label>
                `;
            }).join('');
        };
        
        const renderAssembleResults = (selectedFeatureIds = []) => {
            assembleResultsContainer.innerHTML = '';
            
            // Get constraints
            const maxProficiency = parseInt(assembleTechSlider.value);
            const targetGroupSize = parseInt(assembleSizeSlider.value);
            const strictlyOpenSource = assembleFlossFilter.checked;

            if (selectedFeatureIds.length === 0) {
                 assembleResultsContainer.innerHTML = `
                    <div class="text-center py-12 border-[3px] border-dashed border-gray-300 rounded-lg">
                        <p class="text-gray-500 font-['Space_Mono'] uppercase">Select features on the left to see results.</p>
                    </div>
                 `;
                 return;
            }

            const rankedTech = dataService.getTechnologies().map(tech => {
                const aggData = getAggregateData(tech);
                const matchScore = selectedFeatureIds.reduce((score, sfid) => {
                    return score + (aggData.features.includes(sfid) ? 1 : 0);
                }, 0);
                
                // FILTERING LOGIC
                // 1. Tech Proficiency
                if (aggData.proficiency && aggData.proficiency > maxProficiency + 0.5) return null;

                // 2. Group Size
                if (aggData.groupSize && Math.abs(aggData.groupSize - targetGroupSize) > 1.5) return null;
                
                // 3. Strictly Open Source
                if (strictlyOpenSource && !tech.isOpenSource) return null;

                return { ...tech, matchScore, aggData };
            }).filter(tech => tech && tech.matchScore > 0);

            rankedTech.sort((a, b) => {
                if (b.matchScore !== a.matchScore) {
                    return b.matchScore - a.matchScore;
                }
                if ((b.aggData.conviviality || 0) !== (a.aggData.conviviality || 0)) {
                    return (b.aggData.conviviality || 0) - (a.aggData.conviviality || 0);
                }
                return (a.aggData.proficiency || 10) - (b.aggData.proficiency || 10);
            });


            if (rankedTech.length === 0) {
                 assembleResultsContainer.innerHTML = `
                    <div class="p-6 bg-yellow-100 border-[3px] border-black text-black rounded-lg">
                        <h4 class="font-bold mb-2 font-['Space_Grotesk'] text-xl">NO MATCHES FOUND</h4>
                        <p class="font-['Space_Mono'] text-sm">Try increasing your <strong>Technology knowledge</strong> slider or adjusting the <strong>Group Size</strong> to see more options.${strictlyOpenSource ? '<br>You can also try unchecking "Strictly Open Source".' : ''}</p>
                    </div>`;
                 return;
            }

            const headerHTML = `
                <div class="grid grid-cols-[1fr_auto] gap-4 text-xs font-bold uppercase tracking-wider mb-4 border-b-2 border-black pb-2 font-['Space_Mono']">
                    <span>Technology</span>
                    <div class="grid grid-cols-2 gap-6">
                        <span class="w-16 text-center">Match</span>
                        <span class="w-16 text-center">Conviv.</span>
                    </div>
                </div>
            `;
            assembleResultsContainer.innerHTML = headerHTML;

            dataService.getFunctions().forEach(func => {
                const techForFunc = rankedTech.filter(t => t.aggData.functionIds.includes(func.id));
                if (techForFunc.length > 0) {
                    const techHTML = techForFunc.map(t => {
                        const scores = t.aggData;
                        const convScoreText = scores.conviviality !== null ? scores.conviviality.toFixed(1) : '-';
                        const matchText = `${t.matchScore}/${selectedFeatureIds.length}`;
                        return `
                            <div class="neo-card mb-4 overflow-hidden">
                                <div class="grid grid-cols-[1fr_auto] gap-4 items-center text-sm p-4 hover:bg-gray-50 transition-colors">
                                    <div class="flex items-center tech-name-button font-bold text-lg font-['Space_Grotesk']" data-tech-id="${t.id}">
                                        <span class="caret text-black mr-2"></span>
                                        <span>${t.name}</span>
                                        ${t.isOpenSource ? '<span class="ml-2 tag bg-green-200 border-black" title="Open Source">FLOSS</span>' : ''}
                                    </div>
                                    <div class="grid grid-cols-2 gap-6 font-['Space_Mono']">
                                        <span class="font-bold w-16 text-center bg-black text-white rounded-sm py-1">${matchText}</span>
                                        <span class="font-bold w-16 text-center py-1 border-2 border-black bg-white">${convScoreText}</span>
                                    </div>
                                </div>
                                <div id="comments-assemble-${t.id}" class="hidden text-sm bg-gray-50 border-t-2 border-black p-4 font-['Space_Mono']"></div>
                            </div>
                        `;
                    }).join('');

                    const funcResultEl = document.createElement('div');
                    funcResultEl.innerHTML = `
                        <div class="flex items-center space-x-3 mb-4 mt-8 pb-2 border-b-4" style="border-color: ${func.color}">
                            <div style="background-color: ${func.color}" class="w-4 h-4 border-2 border-black"></div>
                            <h4 class="font-bold text-black text-lg uppercase tracking-wide font-['Space_Grotesk']">${func.name}</h4>
                        </div>
                        <div class="space-y-4">${techHTML}</div>
                    `;
                    assembleResultsContainer.appendChild(funcResultEl);
                }
            });
        };

        const renderEvaluateView = () => {
            renderTechnologyDropdown();
            renderEvaluateFeatures();
            renderConvivialitySliders();
            updateSliderDisplay(evaluateTechSlider, evaluateTechDisplay, 'tech');
            updateSliderDisplay(evaluateSizeSlider, evaluateSizeDisplay, 'size');
        };

        const renderTechnologyDropdown = () => {
            evaluateTechSelect.innerHTML = '<option value="">Select a technology...</option>';
            dataService.getTechnologies().forEach(tech => {
                const option = document.createElement('option');
                option.value = tech.id;
                option.textContent = tech.name;
                evaluateTechSelect.appendChild(option);
            });
        };
        
        const renderEvaluateFeatures = (searchTerm = '') => {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const allFeatures = dataService.getFeatures();
            evaluateFeaturesContainer.innerHTML = allFeatures
                .filter(feat => feat.name.toLowerCase().includes(lowerCaseSearchTerm))
                .map(feat => `
                <label class="flex items-start space-x-2 text-sm p-1 hover:bg-purple-50 rounded cursor-pointer border border-transparent hover:border-black transition-all">
                    <input type="checkbox" value="${feat.id}" class="feature-checkbox mt-1">
                    <span class="font-['Space_Mono']">${feat.name}</span>
                </label>
            `).join('');
        };
        
        const renderTechnologiesList = (container, viewName) => {
            container.innerHTML = '';
            
            const headerHTML = `
                 <div class="grid grid-cols-[1fr_auto] gap-4 text-xs font-bold uppercase tracking-wider mb-4 border-b-2 border-black pb-2 font-['Space_Mono']">
                    <span>Technology</span>
                    <div class="grid grid-cols-2 gap-6">
                        <span class="w-16 text-center">Conviv.</span>
                        <span class="w-16 text-center">Tech Lvl</span>
                    </div>
                </div>
            `;
            container.innerHTML = headerHTML;

            dataService.getFunctions().forEach(func => {
                let techForFunc = dataService.getTechnologies().filter(t => getAggregateData(t).functionIds.includes(func.id));
                
                techForFunc.sort((a, b) => {
                    const scoreA = getAggregateData(a);
                    const scoreB = getAggregateData(b);
                    if ((scoreB.conviviality || 0) !== (scoreA.conviviality || 0)) {
                        return (scoreB.conviviality || 0) - (scoreA.conviviality || 0);
                    }
                    return (scoreA.proficiency || 10) - (scoreB.proficiency || 10);
                });

                if (techForFunc.length > 0) {
                    const techHTML = techForFunc.map(t => {
                        const scores = getAggregateData(t);
                        const convScoreText = scores.conviviality !== null ? scores.conviviality.toFixed(1) : '-';
                        const techScoreText = scores.proficiency !== null ? scores.proficiency.toFixed(1) : '-';
                        return `
                        <div class="neo-card mb-4 overflow-hidden">
                            <div class="grid grid-cols-[1fr_auto] gap-4 items-center text-sm p-4 hover:bg-gray-50 transition-colors">
                                <div class="flex items-center tech-name-button font-bold text-lg font-['Space_Grotesk']" data-tech-id="${t.id}">
                                    <span class="caret text-black mr-2"></span>
                                    <span>${t.name}</span>
                                    ${t.isOpenSource ? '<span class="ml-2 tag bg-green-200 border-black" title="Open Source">FLOSS</span>' : ''}
                                </div>
                                <div class="grid grid-cols-2 gap-6 font-['Space_Mono']">
                                   <span class="font-bold w-16 text-center py-1 border-2 border-black bg-white">${convScoreText}</span>
                                   <span class="font-bold w-16 text-center py-1 border-2 border-black bg-white">${techScoreText}</span>
                                </div>
                            </div>
                            <div id="comments-${viewName}-${t.id}" class="hidden text-sm bg-gray-50 border-t-2 border-black p-4 font-['Space_Mono']"></div>
                        </div>
                    `}).join('');
                    
                    const funcResultEl = document.createElement('div');
                    funcResultEl.innerHTML = `
                        <div class="flex items-center space-x-3 mb-4 mt-8 pb-2 border-b-4" style="border-color: ${func.color}">
                            <div style="background-color: ${func.color}" class="w-4 h-4 border-2 border-black"></div>
                            <h4 class="font-bold text-black text-lg uppercase tracking-wide font-['Space_Grotesk']">${func.name}</h4>
                        </div>
                        <div class="space-y-4">${techHTML}</div>
                    `;
                    container.appendChild(funcResultEl);
                }
            });
        };
        
        const renderAdminDashboard = () => {
            adminDashboardContainer.innerHTML = `
                <div class="space-y-16">
                    <!-- Functions -->
                    <div class="neo-card p-6">
                        <h3 class="text-2xl font-bold mb-6 flex items-center font-['Space_Grotesk'] uppercase border-b-2 border-black pb-2">
                            <span class="tag bg-black text-white mr-3">Core</span>Manage Functions
                        </h3>
                        <table class="admin-table">
                            <thead><tr><th>Name</th><th>Color</th><th class="w-40 text-right">Actions</th></tr></thead>
                            <tbody id="admin-functions-body"></tbody>
                        </table>
                        <form id="add-function-form" class="mt-6 flex space-x-2">
                            <input type="text" placeholder="New function name" class="form-input flex-grow">
                            <button type="submit" class="action-button text-sm !py-2 !px-4">Add</button>
                        </form>
                    </div>
                    <!-- Features -->
                    <div class="neo-card p-6">
                        <h3 class="text-2xl font-bold mb-6 flex items-center font-['Space_Grotesk'] uppercase border-b-2 border-black pb-2">
                            <span class="tag bg-black text-white mr-3">Core</span>Manage Features
                        </h3>
                        <table class="admin-table">
                            <thead><tr><th>Name</th><th>Function</th><th>Used By</th><th class="w-40 text-right">Actions</th></tr></thead>
                            <tbody id="admin-features-body"></tbody>
                        </table>
                         <form id="add-feature-form" class="mt-6 flex space-x-2">
                            <input type="text" placeholder="New feature name" class="form-input flex-grow">
                            <select id="add-feature-function-select" class="form-input w-1/3 border-l-0"></select>
                            <button type="submit" class="action-button text-sm !py-2 !px-4">Add</button>
                         </form>
                    </div>
                    <!-- Technologies -->
                    <div class="neo-card p-6">
                         <h3 class="text-2xl font-bold mb-6 flex items-center font-['Space_Grotesk'] uppercase border-b-2 border-black pb-2">
                            <span class="tag bg-black text-white mr-3">Content</span>Manage Technologies
                         </h3>
                        <table class="admin-table">
                            <thead><tr><th>Name</th><th>Associated Features</th><th class="w-40 text-right">Actions</th></tr></thead>
                            <tbody id="admin-technologies-body"></tbody>
                        </table>
                         <form id="add-technology-form" class="mt-6 flex space-x-2">
                            <input type="text" placeholder="New technology name" class="form-input flex-grow">
                            <button type="submit" class="action-button text-sm !py-2 !px-4">Add</button>
                         </form>
                    </div>
                </div>
            `;
            renderAdminTables();
        };

        const renderAdminTables = () => {
            // Functions
            document.getElementById('admin-functions-body').innerHTML = dataService.getFunctions().map(f => `
                <tr data-id="${f.id}" data-type="function">
                    <td>
                        <span class="view-mode font-bold">${f.name}</span>
                        <input type="text" value="${f.name}" class="form-input edit-mode hidden">
                    </td>
                    <td>
                        <span class="view-mode flex items-center"><div style="background-color:${f.color}" class="w-6 h-6 mr-2 border-2 border-black"></div> <span class="font-mono text-xs">${f.color}</span></span>
                        <input type="color" value="${f.color}" class="form-input edit-mode hidden h-10 w-20 p-1">
                    </td>
                    <td class="text-right">
                        <button class="text-blue-600 hover:underline font-bold text-xs uppercase mr-3 font-mono" data-action="edit">Edit</button>
                        <button class="text-red-600 hover:underline font-bold text-xs uppercase font-mono" data-action="delete">Delete</button>
                    </td>
                </tr>`).join('');

            // Features
            const functionOptions = dataService.getFunctions().map(f => `<option value="${f.id}">${f.name}</option>`).join('');
            document.getElementById('add-feature-function-select').innerHTML = functionOptions;
            document.getElementById('admin-features-body').innerHTML = dataService.getFeatures().map(f => {
                const functionName = dataService.getFunctions().find(fn => fn.id === f.functionId)?.name || 'N/A';
                const techList = dataService.getTechnologies().filter(t => getAggregateData(t).features.includes(f.id));
                const techListHTML = techList.length > 0 ? `<div class="text-xs font-mono">${techList.map(t => t.name).join(', ')}</div>` : '<span class="text-xs text-gray-400 font-mono italic">Unused</span>';

                return `
                <tr data-id="${f.id}" data-type="feature">
                    <td>
                        <span class="view-mode font-bold">${f.name}</span>
                        <input type="text" value="${f.name}" class="form-input edit-mode hidden">
                    </td>
                    <td>
                        <span class="view-mode tag bg-gray-100">${functionName}</span>
                        <select class="form-input edit-mode hidden text-sm">${functionOptions.replace(`value="${f.functionId}"`, `value="${f.functionId}" selected`)}</select>
                    </td>
                    <td><div class="view-mode">${techListHTML}</div></td>
                    <td class="text-right">
                        <button class="text-blue-600 hover:underline font-bold text-xs uppercase mr-3 font-mono" data-action="edit">Edit</button>
                        <button class="text-red-600 hover:underline font-bold text-xs uppercase font-mono" data-action="delete">Delete</button>
                    </td>
                </tr>`;
            }).join('');

            // Technologies
            document.getElementById('admin-technologies-body').innerHTML = dataService.getTechnologies().map(t => {
                const aggData = getAggregateData(t);
                const featureList = `<div class="flex flex-wrap gap-2">${aggData.features.map(fid => `<span class="tag bg-white hover:bg-gray-100">${dataService.getFeatureById(fid)?.name || ''}</span>`).join('')}</div>`;
                
                const unassociatedFeatures = dataService.getFeatures().filter(f => !aggData.features.includes(f.id));
                const addFeatureContainerHTML = unassociatedFeatures.length > 0 ? `
                    <div class="add-feature-container flex space-x-2 mt-2 bg-gray-50 p-2 border-2 border-black border-dashed">
                        <select class="form-input flex-grow text-xs h-8 py-0 border-black">${unassociatedFeatures.map(f => `<option value="${f.id}">${f.name}</option>`).join('')}</select>
                        <button class="text-xs action-button !py-0 !px-3 h-8 flex items-center bg-black text-white" data-action="add-feature">Add</button>
                    </div>` : '';

                const editModeFeaturesHTML = `
                    <div class="edit-mode-features-list space-y-1">
                        ${aggData.features.map(fid => {
                            const feature = dataService.getFeatureById(fid);
                            return feature ? `<div class="edit-mode-item text-xs font-mono bg-white border border-black p-1 flex justify-between items-center" data-feature-id="${fid}"><span>${feature.name}</span><button class="text-red-600 hover:bg-red-600 hover:text-white font-bold ml-2 px-1" data-action="remove-feature"></button></div>` : '';
                        }).join('')}
                    </div>
                    ${addFeatureContainerHTML}`;

                return `
                <tr data-id="${t.id}" data-type="technology">
                    <td>
                        <span class="view-mode font-bold text-lg">${t.name}</span>
                        <input type="text" value="${t.name}" class="form-input edit-mode hidden">
                    </td>
                    <td>
                        <div class="view-mode">${aggData.features.length > 0 ? featureList : '<span class="text-gray-400 font-mono italic">No features associated</span>'}</div>
                        <div class="edit-mode hidden">${editModeFeaturesHTML}</div>
                    </td>
                    <td class="text-right">
                        <button class="text-blue-600 hover:underline font-bold text-xs uppercase mr-3 font-mono" data-action="edit">Edit</button>
                        <button class="text-red-600 hover:underline font-bold text-xs uppercase font-mono" data-action="delete">Delete</button>
                    </td>
                </tr>`;
            }).join('');
        };

        // --- EVENT LISTENERS ---
        document.addEventListener('click', (e) => {
            const navLink = e.target.closest('.nav-link');
            if (navLink) {
                e.preventDefault();
                const pageId = navLink.getAttribute('href').substring(1) + '-page';
                showPage(pageId);
                
                // Update URL hash without scrolling
                history.pushState(null, null, navLink.getAttribute('href'));
            }
            if (e.target.closest('#home-logo')) {
                showPage('main-content');
                history.pushState(null, null, '#');
            }
            if (e.target.id === 'admin-logout') {
                 showPage('main-content');
            }
        });

        document.getElementById('admin-login-link').addEventListener('click', (e) => {
            e.preventDefault();
            showPage('admin-login-page');
        });

        adminLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('admin-login-error');
            if (email === 'admin@cos.com' && password === 'password') {
                errorEl.classList.add('hidden');
                showPage('admin-dashboard-page');
            } else {
                errorEl.classList.remove('hidden');
            }
        });
        
        adminDashboardContainer.addEventListener('click', (e) => {
            const target = e.target;
            const action = target.dataset.action;
            const row = target.closest('tr');
            if (!row && !(action === 'add-feature' || action === 'remove-feature')) return;

            const id = row?.dataset.id;
            const type = row?.dataset.type;

            if (action === 'edit') {
                row.querySelectorAll('.view-mode').forEach(el => el.classList.add('hidden'));
                row.querySelectorAll('.edit-mode').forEach(el => el.classList.remove('hidden'));
                target.textContent = 'SAVE';
                target.dataset.action = 'save';
                target.classList.remove('text-blue-600');
                target.classList.add('text-green-600');
                // Hide 'add' dropdown if no options
                if(type === 'technology'){
                    const select = row.querySelector('.add-feature-container select');
                    if (select && select.options.length === 0) {
                        row.querySelector('.add-feature-container').classList.add('hidden');
                    }
                }
            } else if (action === 'save') {
                if (type === 'function') {
                    const newName = row.querySelector('input[type="text"]').value;
                    const newColor = row.querySelector('input[type="color"]').value;
                    dataService.updateFunction(id, newName, newColor);
                } else if (type === 'technology') {
                    const newName = row.querySelector('input[type="text"]').value;
                    const featureList = row.querySelector('.edit-mode-features-list');
                    const featureIds = Array.from(featureList.children).map(child => child.dataset.featureId);
                    dataService.updateTechnology(id, newName, featureIds);
                } else if (type === 'feature') {
                     const newName = row.querySelector('input[type="text"]').value;
                     const newFunctionId = row.querySelector('select').value;
                     dataService.updateFeature(id, newName, newFunctionId);
                }
                renderAdminTables();
            } else if (action === 'delete') {
                if (confirm('Are you sure you want to delete this item?')) {
                    if (type === 'function') dataService.deleteFunction(id);
                    if (type === 'feature') dataService.deleteFeature(id);
                    if (type === 'technology') dataService.deleteTechnology(id);
                    renderAdminTables();
                }
            } else if (action === 'add-feature') {
                const techRow = target.closest('tr');
                const select = target.previousElementSibling;
                const featureId = select.value;
                if (!featureId) return;
                const feature = dataService.getFeatureById(featureId);
                const list = techRow.querySelector('.edit-mode-features-list');
                const newItem = document.createElement('div');
                newItem.className = 'edit-mode-item text-xs font-mono bg-white border border-black p-1 flex justify-between items-center';
                newItem.dataset.featureId = featureId;
                newItem.innerHTML = `<span>${feature.name}</span><button class="text-red-600 hover:bg-red-600 hover:text-white font-bold ml-2 px-1" data-action="remove-feature"></button>`;
                list.appendChild(newItem);
                select.remove(select.selectedIndex);
                if (select.options.length === 0) {
                    techRow.querySelector('.add-feature-container').classList.add('hidden');
                }
            } else if (action === 'remove-feature') {
                const techRow = target.closest('tr');
                const item = target.closest('.edit-mode-item');
                const featureId = item.dataset.featureId;
                const feature = dataService.getFeatureById(featureId);
                const select = techRow.querySelector('.edit-mode select');
                const newOption = document.createElement('option');
                newOption.value = featureId;
                newOption.textContent = feature.name;
                select.appendChild(newOption);
                techRow.querySelector('.add-feature-container').classList.remove('hidden');
                item.remove();
            }
        });

        adminDashboardContainer.addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const input = form.querySelector('input');
            const name = input.value.trim();
            if (!name) return;

            if (form.id === 'add-function-form') dataService.addFunction(name);
            if (form.id === 'add-feature-form') {
                const functionId = form.querySelector('select').value;
                dataService.addFeature(name, functionId);
            }
            if (form.id === 'add-technology-form') dataService.addTechnology(name);
            
            input.value = '';
            renderAdminTables();
        });
        
        assembleFeaturesContainer.addEventListener('change', () => {
            const selectedCheckboxes = assembleFeaturesContainer.querySelectorAll('input[type="checkbox"]:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            renderAssembleResults(selectedIds);
        });

        // Sliders event listeners
        assembleTechSlider.addEventListener('input', () => {
             updateSliderDisplay(assembleTechSlider, assembleTechDisplay, 'tech');
             const selectedCheckboxes = assembleFeaturesContainer.querySelectorAll('input[type="checkbox"]:checked');
             const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
             renderAssembleResults(selectedIds);
        });

        assembleSizeSlider.addEventListener('input', () => {
             updateSliderDisplay(assembleSizeSlider, assembleSizeDisplay, 'size');
             const selectedCheckboxes = assembleFeaturesContainer.querySelectorAll('input[type="checkbox"]:checked');
             const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
             renderAssembleResults(selectedIds);
        });
        
        assembleFlossFilter.addEventListener('change', () => {
             const selectedCheckboxes = assembleFeaturesContainer.querySelectorAll('input[type="checkbox"]:checked');
             const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
             renderAssembleResults(selectedIds);
        });

        evaluateTechSlider.addEventListener('input', () => {
             updateSliderDisplay(evaluateTechSlider, evaluateTechDisplay, 'tech');
        });

        evaluateSizeSlider.addEventListener('input', () => {
             updateSliderDisplay(evaluateSizeSlider, evaluateSizeDisplay, 'size');
        });

        newTechnologyInput.addEventListener('keypress', (e) => {
             if (e.key === 'Enter' && newTechnologyInput.value.trim() !== '') {
                e.preventDefault();
                const newTech = dataService.addTechnology(newTechnologyInput.value.trim());
                renderEvaluateView();
                evaluateTechSelect.value = newTech.id;
                newTechnologyInput.value = '';
            }
        });
        
        evaluateFeaturesSearch.addEventListener('keyup', (e) => {
            renderEvaluateFeatures(e.target.value);
        });
        
        saveEvaluationButton.addEventListener('click', () => {
            saveErrorMessage.classList.add('hidden');
            saveConfirmationMessage.classList.add('hidden');

            const techId = parseInt(evaluateTechSelect.value);
            if (!techId) {
                saveErrorMessage.textContent = 'Please select a technology to evaluate.';
                saveErrorMessage.classList.remove('hidden');
                return;
            }
            const technology = dataService.getTechnologyById(techId);
            
            const convSliders = convivialitySlidersContainer.querySelectorAll('input[type="range"]');
            const totalConvScore = Array.from(convSliders).reduce((sum, slider) => sum + parseInt(slider.value), 0);
            const avgConvScore = totalConvScore / convSliders.length;

            const newEvaluation = {
                techProficiency: parseInt(evaluateTechSlider.value), // Use slider value
                groupSize: parseInt(evaluateSizeSlider.value),       // Use slider value
                convivialityScore: avgConvScore,
                comment: evaluationComment.value,
                features: Array.from(document.getElementById('evaluate-features-container').querySelectorAll('input:checked')).map(cb => cb.value)
            };
            
            dataService.addEvaluation(techId, newEvaluation);
            dataService.incrementVersion();
            updateVersionTracker();
            
            saveConfirmationMessage.classList.remove('hidden');
            setTimeout(() => saveConfirmationMessage.classList.add('hidden'), 3000);

            // Clear form
            const form = document.getElementById('evaluate-form-container');
            form.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
            form.querySelectorAll('textarea, input[type="search"]').forEach(t => t.value = '');
            // Uncheck boxes
            form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            // Reset sliders
            convSliders.forEach(s => {
                s.value = 5;
                const display = document.getElementById(`val-${s.dataset.convId}`);
                if(display) display.textContent = '5';
            });
            // Reset main sliders
            evaluateTechSlider.value = 3; updateSliderDisplay(evaluateTechSlider, evaluateTechDisplay, 'tech');
            evaluateSizeSlider.value = 2; updateSliderDisplay(evaluateSizeSlider, evaluateSizeDisplay, 'size');

            renderEvaluateFeatures();
        });
        
        const handleCommentToggle = (event) => {
            const button = event.target.closest('.tech-name-button');
            if (button) {
                const techId = button.dataset.techId;
                const view = event.currentTarget.dataset.view;
                const commentsContainer = document.getElementById(`comments-${view}-${techId}`);
                const caret = button.querySelector('.caret');
                
                commentsContainer.classList.toggle('hidden');
                caret.classList.toggle('caret-open');

                if (!commentsContainer.classList.contains('hidden')) {
                     const technology = dataService.getTechnologyById(parseInt(techId));
                     const aggData = getAggregateData(technology);
                     
                     let featuresHTML = '<p class="font-bold mb-1 uppercase text-xs">Supported Features:</p>';
                     if (aggData.features.length > 0) {
                         const featureList = aggData.features.map(fid => {
                            const feature = dataService.getFeatureById(fid);
                            return `<li class="ml-4">${feature ? feature.name : 'Unknown feature'}</li>`;
                         }).join('');
                         featuresHTML += `<ul class="list-disc list-outside mb-4 text-gray-700 font-mono text-xs">${featureList}</ul>`;
                     } else {
                         featuresHTML += '<p class="text-gray-400 font-mono italic mb-4">No features listed.</p>';
                     }

                     let commentsHTML = '<p class="font-bold mb-2 uppercase text-xs">User Reviews:</p>';
                     const comments = technology.evaluations.filter(ev => ev.comment && ev.comment.trim() !== '' && !ev.isAdminAssigned);
                     if (comments.length > 0) {
                        commentsHTML += comments.map(ev => `<div class="bg-white p-3 border-2 border-black mb-2 italic text-black shadow-[2px_2px_0px_0px_#000]">"${ev.comment}"</div>`).join('');
                     } else {
                        commentsHTML += '<p class="text-gray-400 font-mono italic">No comments yet.</p>';
                     }

                     commentsContainer.innerHTML = featuresHTML + commentsHTML;
                }
            }
        };

        assembleResultsContainer.dataset.view = 'assemble';
        technologiesListContainer.dataset.view = 'technologies';
        assembleResultsContainer.addEventListener('click', handleCommentToggle);
        technologiesListContainer.addEventListener('click', handleCommentToggle);
        
        // --- ROUTING & INITIALIZATION ---
        const handleRouting = () => {
            const hash = window.location.hash || '#';
            const pageId = hash.substring(1) ? hash.substring(1) + '-page' : 'main-content';
            showPage(pageId);
        };

        window.addEventListener('hashchange', handleRouting);
        handleRouting(); // Initial page load
        updateVersionTracker();
        renderLogo(); // Render initial logo
    });
    </script>
</body>
</html>
