<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convivial Operating Stack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { background-color: #fff; font-family: 'Inter', sans-serif; }
        .form-input { border: 1px solid #d1d5db; border-radius: 0.25rem; padding: 0.5rem 0.75rem; width: 100%; }
        .form-input:focus { outline: 2px solid #a78bfa; border-color: transparent; }
        .action-button { background-color: #374151; color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.25rem; transition: all 0.2s; display: inline-block; text-align: center; cursor: pointer; }
        .action-button:hover { background-color: #111827; transform: translateY(-1px); }
        .action-button.active { background-color: #000; }
        .feature-checkbox { accent-color: #a78bfa; width: 1.15rem; height: 1.15rem; margin-top: 2px; }
        
        /* Custom slider styles */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #e2e8f0; border-radius: 9999px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #4b5563; cursor: pointer; margin-top: -6px; transition: background 0.2s; }
        input[type=range]::-webkit-slider-thumb:hover { background: #1f2937; }
        input[type=range]::-moz-range-track { width: 100%; height: 6px; cursor: pointer; background: #e2e8f0; border-radius: 9999px; }
        input[type=range]::-moz-range-thumb { height: 18px; width: 18px; border-radius: 50%; background: #4b5563; cursor: pointer; border: none; }

        .tech-name-button { cursor: pointer; user-select: none; }
        .tech-name-button:hover { text-decoration: underline; }
        .caret { transition: transform 0.2s ease-in-out; display: inline-block; margin-right: 0.5rem; }
        .caret-open { transform: rotate(90deg); }
        .page-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page-content.active { display: block; }
        
        /* Admin Table */
        .admin-table { width: 100%; border-collapse: separate; border-spacing: 0; border: 1px solid #e2e8f0; border-radius: 0.5rem; overflow: hidden; }
        .admin-table th, .admin-table td { padding: 12px; text-align: left; font-size: 0.875rem; vertical-align: top; border-bottom: 1px solid #e2e8f0; }
        .admin-table th { background-color: #f8fafc; font-weight: 600; color: #475569; }
        .admin-table tr:last-child td { border-bottom: none; }
        .admin-table tr:hover td { background-color: #f8fafc; }
        
        .hidden { display: none !important; }
        .admin-table .edit-mode-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; background: #f1f5f9; margin-bottom: 2px; border-radius: 4px; }
        .new-flag { background-color: #22c55e; color: white; font-size: 0.65rem; font-weight: bold; padding: 2px 6px; border-radius: 9999px; margin-left: 8px; text-transform: uppercase; letter-spacing: 0.05em; }
        .admin-table .view-mode ul { list-style-position: inside; padding-left: 4px; margin: 0; }
        .admin-table .view-mode li::marker { content: 'â€¢ '; color: #94a3b8; }
        
        .slider-container { padding: 1rem; background-color: #f9fafb; border-radius: 0.5rem; border: 1px solid #e5e7eb; margin-bottom: 1.5rem; }
        .slider-label { font-size: 0.75rem; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; display: block; }
        .slider-value-display { font-size: 0.875rem; font-weight: 600; color: #1f2937; margin-top: 0.25rem; }
        
        /* Logo Styles */
        .logo-bubble { position: absolute; border-radius: 50%; mix-blend-mode: multiply; opacity: 0.7; transition: all 0.3s ease; }
        .logo-bubble:hover { opacity: 1; transform: scale(1.1); z-index: 10; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Indie+Flower&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="text-gray-800 antialiased min-h-screen flex flex-col">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl flex-grow">
        <header class="flex flex-col md:flex-row justify-between items-center py-6 border-b border-gray-100 mb-8">
            <div id="home-logo" class="h-16 w-16 relative cursor-pointer mb-4 md:mb-0" title="Functions scaled by feature count">
                <!-- SVG/Bubbles injected by JS -->
            </div>
            <nav class="flex flex-wrap justify-center space-x-6 text-sm font-medium text-gray-500">
                <a href="#technologies" class="nav-link hover:text-black transition-colors">All technologies</a>
            </nav>
        </header>

        <main id="main-content" class="page-content active">
            <!-- 1. Hero Section -->
            <section id="hero-section">
                <div class="grid md:grid-cols-2 gap-12 py-12 items-center">
                    <div class="flex flex-col justify-center">
                        <h1 class="text-5xl md:text-6xl font-bold leading-tight tracking-tight text-gray-900">Convivial<br>Operating<br>Stack</h1>
                        <p class="mt-6 text-xl md:text-2xl text-gray-600 font-light">A toolbox of technologies tried and tested by countercultures.</p>
                    </div>
                    <div class="flex items-center justify-center md:justify-end">
                        <div class="transform rotate-[-6deg]">
                            <p class="text-4xl md:text-5xl text-gray-800 uppercase" style="font-family: 'Indie Flower', cursive; line-height: 1.2;">
                                the more we<br>share the more<br>we have
                            </p>
                        </div>
                    </div>
                </div>
                <div class="text-gray-600 space-y-4 text-sm border-t border-gray-100 pt-12 mt-4 max-w-4xl">
                     <p>The COS is a continously evolving toolbox that various post-growth groups are using as their technological infrastructure. It supports methodological luddism - to help choose which technologies you actually need, and which you don't need.</p>
                     
                     <div class="flex flex-col md:flex-row gap-6 items-center pt-8">
                        <a href="#assemble" class="action-button nav-link shadow-xl bg-gray-900 text-lg px-8 py-4">Assemble your Convivial Operating Stack</a>
                        <span class="text-gray-400 italic font-serif text-lg">or</span>
                        <a href="#evaluate" class="action-button nav-link bg-white text-gray-800 border-2 border-gray-200 hover:bg-gray-50 hover:border-gray-400 text-lg px-8 py-4">Evaluate technologies you've tested</a>
                        <span id="version-tracker" class="text-xs text-gray-400 font-mono pl-2 mt-4 md:mt-0"></span>
                     </div>
                </div>
            </section>
        </main>

        <!-- 5a. Assemble COS Page -->
        <section id="assemble-page" class="page-content">
            <h2 class="text-3xl font-bold mb-8">Assemble your Convivial Operating Stack</h2>
            <div class="grid md:grid-cols-2 gap-12 relative">
                <div class="md:border-r md:border-gray-200 md:pr-12">
                    <div class="sticky top-4">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Your Group</h3>
                        
                        <div class="mb-6 p-4 bg-teal-50 border border-teal-100 rounded-lg">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="assemble-floss-filter" class="feature-checkbox h-5 w-5 text-teal-600 rounded">
                                <span class="text-sm font-bold text-teal-900">Strictly Open Source</span>
                            </label>
                            <p class="text-xs text-teal-600 mt-1 ml-8">Only show Open Source</p>
                        </div>

                        <div class="slider-container">
                            <label class="slider-label">Technology knowledge</label>
                            <input type="range" id="assemble-tech-slider" min="1" max="5" step="1" value="3">
                            <div id="assemble-tech-display" class="slider-value-display">Comfortable with new software</div>
                        </div>
                        <div class="slider-container">
                            <label class="slider-label">Group Size</label>
                            <input type="range" id="assemble-size-slider" min="1" max="5" step="1" value="2">
                            <div id="assemble-size-display" class="slider-value-display">Smallish Group (6-15)</div>
                        </div>

                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 mt-8">Features Needed</h3>
                        <p class="text-gray-600 mb-6 text-sm">Select the features useful to your group.</p>
                        <div id="assemble-features-container" class="space-y-3 max-h-[40vh] overflow-y-auto pr-2"></div>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Recommended Stack</h3>
                    <p class="text-gray-600 mb-6 text-sm">Technologies ranked by how well they match what you need.</p>
                    <div id="assemble-results-container" class="space-y-8"></div>
                </div>
            </div>
        </section>

        <!-- 5b. Evaluate Technologies Page -->
        <section id="evaluate-page" class="page-content">
             <div class="max-w-2xl mx-auto">
                <h2 class="text-3xl font-bold mb-2">Evaluation</h2>
                <p class="text-gray-500 mb-8">Share your experience of specific technologies.</p>
                
                <div id="evaluate-form-container" class="space-y-6 bg-gray-50 p-8 rounded-xl border border-gray-100">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Which technology are we talking about?</label>
                        <select id="evaluate-tech-select" class="form-input bg-white"></select>
                        <input type="text" id="new-technology-input" class="form-input mt-2 text-sm bg-white" placeholder="Or add a new technology + Enter...">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Required technology knowledge</label>
                            <div class="bg-white p-3 border rounded">
                                <input type="range" id="evaluate-tech-slider" min="1" max="5" step="1" value="3" class="w-full">
                                <div id="evaluate-tech-display" class="text-xs text-center font-bold mt-1 text-purple-600">Comfortable with new software</div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Used for group size</label>
                            <div class="bg-white p-3 border rounded">
                                <input type="range" id="evaluate-size-slider" min="1" max="5" step="1" value="2" class="w-full">
                                <div id="evaluate-size-display" class="text-xs text-center font-bold mt-1 text-purple-600">Smallish Group (6-15)</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">What does it help out with?</label>
                        <input type="search" id="evaluate-features-search" class="form-input text-sm bg-white mb-2" placeholder="Search features...">
                        <div id="evaluate-features-container" class="p-3 border border-gray-200 rounded-md max-h-40 overflow-y-auto bg-white"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Which ends does it support?</label>
                        <div id="evaluate-purposes-container" class="p-3 border border-gray-200 rounded-md max-h-32 overflow-y-auto bg-white"></div>
                        <input type="text" id="new-purpose-input" class="form-input mt-2 text-sm bg-white" placeholder="Add a new purpose + Enter...">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Comments</label>
                        <textarea id="evaluation-comment" class="form-input bg-white" rows="3" placeholder="Your review of how this was useful/not useful for your group."></textarea>
                    </div>
                    <div id="conviviality-questions" class="pt-4 border-t border-gray-200">
                         <div class="flex justify-between items-baseline mb-4">
                            <label class="block text-sm font-semibold text-gray-700">Conviviality Score</label>
                            <span class="text-xs text-gray-400 italic">Based on the Matrix of Convivial Technology (Vetter, 2018)</span>
                         </div>
                         <div id="conviviality-sliders-container" class="space-y-5"></div>
                    </div>
                    <div class="pt-4">
                        <button id="save-evaluation-button" class="action-button w-full md:w-auto">Submit Evaluation</button>
                        <p id="save-error-message" class="text-sm text-red-600 mt-3 hidden"></p>
                        <p id="save-confirmation-message" class="text-sm text-green-600 mt-3 hidden font-medium flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                            <span>Evaluation saved successfully.</span>
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <section id="technologies-page" class="page-content">
             <h2 class="text-3xl font-bold mb-8">Technologies</h2>
             <div id="technologies-list-container" class="space-y-12"></div>
        </section>

        <section id="admin-login-page" class="page-content">
            <div class="max-w-md mx-auto mt-12 bg-gray-50 p-8 rounded-xl border border-gray-100">
                <h2 class="text-2xl font-bold mb-6 text-center">Admin Login</h2>
                <form id="admin-login-form" class="space-y-4">
                    <div>
                        <label for="admin-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="admin-email" class="form-input bg-white" value="admin@cos.com">
                    </div>
                    <div>
                        <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="admin-password" class="form-input bg-white" value="password">
                    </div>
                    <p id="admin-login-error" class="text-red-500 text-sm hidden bg-red-50 p-2 rounded">Invalid credentials.</p>
                    <button type="submit" class="action-button w-full">Login</button>
                    <p class="text-xs text-center text-gray-400 mt-4">Hint: Use pre-filled credentials</p>
                </form>
            </div>
        </section>
        
        <section id="admin-dashboard-page" class="page-content">
            <div class="flex justify-between items-end mb-8">
                <h2 class="text-3xl font-bold">Admin Dashboard</h2>
                <button id="admin-logout" class="text-sm text-red-500 hover:text-red-700 font-medium">Logout</button>
            </div>
            <div id="admin-dashboard-container" class="space-y-12"></div>
        </section>

        <footer class="text-right py-8 mt-12 border-t border-gray-100">
            <div class="container mx-auto px-4">
                <a href="#admin-login" id="admin-login-link" class="nav-link text-xs text-gray-400 hover:text-gray-600 transition-colors">Admin Login</a>
            </div>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA ---
        const appData = {
            version: 1.7,
            // Colors: Magenta, Purple, Teal, Yellow
            functions: [
                { id: 'commons', name: 'Collaborative Commons', color: '#db2777', accent: 'accent-pink-600' }, // Magenta (pink-600)
                { id: 'admin', name: 'Assisted Administration', color: '#9333ea', accent: 'accent-purple-600' }, // Purple (purple-600)
                { id: 'production', name: 'Peer Production', color: '#0d9488', accent: 'accent-teal-600' }, // Teal (teal-600)
                { id: 'economy', name: 'Egalitarian Economy', color: '#ca8a04', accent: 'accent-yellow-600' }, // Yellow (yellow-600 - darker for text contrast)
            ],
            // Features mapped to the new 4 functions
            features: [
                // Collaborative Commons (Communication, Decisions, Knowledge, Connection)
                {id: 'f1', name: 'Find and connect with others', functionId: 'commons'},
                {id: 'f2', name: 'Communicate around projects', functionId: 'commons'},
                {id: 'f3', name: 'Brainstorm ideas together', functionId: 'commons'},
                {id: 'f9', name: 'Build a shared knowledge base', functionId: 'commons'},
                {id: 'f_save', name: 'Save web content for later', functionId: 'commons'},
                {id: 'f_blog', name: 'Publish news or a blog', functionId: 'commons'},
                {id: 'f_event', name: 'Organize events', functionId: 'commons'},
                {id: 'f_plan1', name: 'Agree on meeting dates', functionId: 'commons'},
                {id: 'f_decide', name: 'Make collective decisions', functionId: 'commons'},
                {id: 'f_map', name: 'Create mind maps', functionId: 'commons'},

                // Assisted Administration (Org, Tasks, Forms)
                {id: 'f6', name: 'Track tasks and projects', functionId: 'admin'},
                {id: 'f7', name: 'Store and organize documents', functionId: 'admin'},
                {id: 'f10', name: 'Distribute admin tasks', functionId: 'admin'},
                {id: 'f11', name: 'Gather information (Forms)', functionId: 'admin'},
                {id: 'f_form', name: 'Create online forms', functionId: 'admin'},
                {id: 'f_kanban', name: 'Visual task boards (Kanban)', functionId: 'admin'},

                // Peer Production (Making things: Code, Design, Text, Resources)
                {id: 'f8', name: 'Book shared resources/tools', functionId: 'production'},
                {id: 'f_write', name: 'Collaborative writing', functionId: 'production'},
                {id: 'f_git', name: 'Host and version code', functionId: 'production'},
                {id: 'f_video', name: 'Host and share videos', functionId: 'production'},
                {id: 'f_3d', name: 'Share 3D designs', functionId: 'production'},

                // Egalitarian Economy (Money, Value)
                {id: 'f4', name: 'Manage shared finances', functionId: 'economy'},
                {id: 'f5', name: 'Create and manage budgets', functionId: 'economy'},
                {id: 'f_calc', name: 'Collaborative spreadsheets', functionId: 'economy'},
                {id: 'f12', name: 'Handle expense reimbursements', functionId: 'economy'},
                {id: 'f13', name: 'Manage membership fees', functionId: 'economy'},
                {id: 'f14', name: 'Funding for events', functionId: 'economy'},
                {id: 'f15', name: 'Receive outside funding', functionId: 'economy'},
            ],
            techProficiencyLevels: [
                { id: 1, name: 'Happy luddites' },
                { id: 2, name: 'Basic technology users (email, social media)' },
                { id: 3, name: 'Comfortable with new software' },
                { id: 4, name: 'Some technology experts in the group' },
                { id: 5, name: 'Able to code' },
            ],
            groupSizes: [
                { id: 1, name: 'Testing out idea (<5)' },
                { id: 2, name: 'Working Group (6-15)' },
                { id: 3, name: 'Community (16-50)' },
                { id: 4, name: 'Network (50-200)' },
                { id: 5, name: 'Movement (200+)' },
            ],
            technologies: [
                { id: 1, name: 'Discord', isOpenSource: false, evaluations: [
                    { techProficiency: 3, groupSize: 4, convivialityScore: 2.5, comment: "Great for quick chats, but can be overwhelming and extractive.", features: ['f1', 'f2'], purposes: ['p1'] },
                ]},
                { id: 2, name: 'WhatsApp', isOpenSource: false, evaluations: [
                     { techProficiency: 1, groupSize: 2, convivialityScore: 1.5, comment: "Super easy to use, but owned by Meta. Privacy concerns.", features: ['f1', 'f2'], purposes: ['p1'] }
                ]},
                { id: 3, name: 'Open Collective', isOpenSource: true, evaluations: [
                    { techProficiency: 2, groupSize: 3, convivialityScore: 9.2, comment: "A game-changer for transparent finances and reducing admin load.", features: ['f10', 'f11', 'f12', 'f13', 'f14', 'f15', 'f4', 'f5'], purposes: ['p2'] }
                ] },
                { id: 4, name: 'Trello', isOpenSource: false, evaluations: [
                    { techProficiency: 2, groupSize: 2, convivialityScore: 3.0, comment: "Visual and intuitive, but proprietary software.", features: ['f6', 'f_kanban'], purposes: ['p1', 'p2'] }
                ]},
                { id: 5, name: 'Facebook', isOpenSource: false, evaluations: [
                    { techProficiency: 4, groupSize: 5, convivialityScore: 1.0, comment: "Feels invasive and constantly tries to sell you things. Hard to control your own data.", features: ['f1', 'f2'], purposes: ['p1'] }
                ]},
                // Framasoft Suite
                { id: 6, name: 'Framadate', isOpenSource: true, evaluations: [
                    { techProficiency: 1, groupSize: 2, convivialityScore: 9.8, comment: "Simple, ethical scheduling without ads.", features: ['f_plan1'], purposes: ['p1'] }
                ]},
                { id: 7, name: 'Framapad', isOpenSource: true, evaluations: [
                    { techProficiency: 2, groupSize: 2, convivialityScore: 9.5, comment: "Excellent for taking minutes together in real time.", features: ['f_write', 'f3'], purposes: ['p1'] }
                ]},
                { id: 8, name: 'Framacalc', isOpenSource: true, evaluations: [
                    { techProficiency: 2, groupSize: 2, convivialityScore: 9.0, comment: "Like Excel but online and collaborative. Very useful.", features: ['f_calc', 'f4', 'f5'], purposes: ['p2'] }
                ]},
                { id: 9, name: 'Framavox', isOpenSource: true, evaluations: [
                    { techProficiency: 3, groupSize: 3, convivialityScore: 8.8, comment: "Great for Loomio-style decision making.", features: ['f_decide', 'f3'], purposes: ['p1'] }
                ]},
                { id: 10, name: 'Framaforms', isOpenSource: true, evaluations: [
                    { techProficiency: 2, groupSize: 4, convivialityScore: 9.2, comment: "Drag and drop form builder, respectful of privacy.", features: ['f_form', 'f11'], purposes: ['p1'] }
                ]},
                { id: 11, name: 'Framamind', isOpenSource: true, evaluations: [
                    { techProficiency: 2, groupSize: 2, convivialityScore: 8.5, comment: "Good for initial brainstorming sessions.", features: ['f_map', 'f3'], purposes: ['p1'] }
                ]},
                { id: 12, name: 'Mobilizon', isOpenSource: true, evaluations: [
                    { techProficiency: 3, groupSize: 4, convivialityScore: 9.2, comment: "A powerful alternative to Facebook Events.", features: ['f_event', 'f1', 'f2'], purposes: ['p1'] }
                ]},
                { id: 13, name: 'Framagit', isOpenSource: true, evaluations: [
                    { techProficiency: 4, groupSize: 3, convivialityScore: 9.0, comment: "Essential for sharing code and open source projects.", features: ['f_git', 'f7'], purposes: ['p3'] }
                ]},
                { id: 14, name: 'Framatalk', isOpenSource: true, evaluations: [
                    { techProficiency: 2, groupSize: 1, convivialityScore: 8.5, comment: "Video conferencing that just works in the browser.", features: ['f2'], purposes: ['p1'] }
                ]},
                { id: 15, name: 'Framaspace', isOpenSource: true, evaluations: [
                    { techProficiency: 3, groupSize: 3, convivialityScore: 9.5, comment: "Complete cloud storage and collaboration suite based on Nextcloud.", features: ['f7', 'f2', 'f11'], purposes: ['p1'] }
                ]},
                { id: 16, name: 'Framalistes', isOpenSource: true, evaluations: [
                    { techProficiency: 2, groupSize: 4, convivialityScore: 9.0, comment: "Classic email lists for group coordination.", features: ['f2'], purposes: ['p1'] }
                ]},
                { id: 17, name: 'Framateam', isOpenSource: true, evaluations: [
                    { techProficiency: 3, groupSize: 3, convivialityScore: 9.0, comment: "Team chat alternative to Slack/Discord.", features: ['f1', 'f2'], purposes: ['p1'] }
                ]},
                { id: 18, name: 'Framaboard', isOpenSource: true, evaluations: [
                    { techProficiency: 2, groupSize: 2, convivialityScore: 9.0, comment: "Kanban board for task management. Alternative to Trello.", features: ['f6', 'f_kanban'], purposes: ['p1'] }
                ]},
                { id: 19, name: 'Framabag', isOpenSource: true, evaluations: [
                    { techProficiency: 2, groupSize: 1, convivialityScore: 9.2, comment: "Save web pages to read later. Alternative to Pocket.", features: ['f_save', 'f11'], purposes: ['p1'] }
                ]},
                { id: 20, name: 'PeerTube', isOpenSource: true, evaluations: [
                    { techProficiency: 4, groupSize: 4, convivialityScore: 9.5, comment: "Decentralized video hosting platform. Alternative to YouTube.", features: ['f_video', 'f7'], purposes: ['p1'] }
                ]},
                { id: 21, name: 'Framablog', isOpenSource: true, evaluations: [
                    { techProficiency: 3, groupSize: 3, convivialityScore: 9.0, comment: "Lightweight blog to share news.", features: ['f_blog', 'f1'], purposes: ['p1'] }
                ]},
                // Added Thingiverse
                { id: 22, name: 'Thingiverse', isOpenSource: false, evaluations: [
                    { techProficiency: 3, groupSize: 5, convivialityScore: 4.0, comment: "Massive library of 3D designs, but corporate-owned.", features: ['f_3d'], purposes: ['p1'] }
                ]}
            ],
            purposes: [
                { id: 'p1', name: 'Own land' },
                { id: 'p2', name: 'Own property' },
                { id: 'p3', name: 'Be self-sufficient in energy' }
            ],
            // Modified per Vetter (2018)
            convivialityQuestions: [
                { id: 'relatedness', question: 'Relatedness: Does it help us relate to each other?' },
                { id: 'accessibility', question: 'Accessibility: Can anyone access and understand it?' },
                { id: 'adaptability', question: 'Adaptability: Can we adapt and repair it?' },
                { id: 'biointeraction', question: 'Bio-interaction: Is it compatible with life?' },
                { id: 'appropriateness', question: 'Appropriateness: Does it fit our specific situation?' },
            ]
        };

        const dataService = {
            getVersion: () => appData.version,
            incrementVersion: () => { appData.version = parseFloat((appData.version + 0.1).toFixed(1)); },
            // GETTERS
            getFunctions: () => appData.functions,
            getFeatures: () => appData.features,
            getTechnologies: () => appData.technologies,
            getPurposes: () => appData.purposes,
            getTechProficiencyLevels: () => appData.techProficiencyLevels,
            getGroupSizes: () => appData.groupSizes,
            getConvivialityQuestions: () => appData.convivialityQuestions,
            getFeaturesByFunction: (functionId) => appData.features.filter(f => f.functionId === functionId),
            getFeatureById: (id) => appData.features.find(f => f.id === id),
            getTechnologyById: (id) => appData.technologies.find(t => t.id === id),
            
            // ADDERS
            addFunction: (name) => {
                const colors = ['#db2777', '#9333ea', '#0d9488', '#ca8a04'];
                const accents = ['accent-pink-600', 'accent-purple-600', 'accent-teal-600', 'accent-yellow-600'];
                const nextColorIndex = appData.functions.length % colors.length;
                const newFunc = { id: `func${Date.now()}`, name, color: colors[nextColorIndex], accent: accents[nextColorIndex] };
                appData.functions.push(newFunc);
                renderLogo(); // Re-render logo on change
            },
            addFeature: (name, functionId) => {
                const newFeature = { id: `f${Date.now()}`, name, functionId, isNew: true };
                appData.features.push(newFeature);
                renderLogo(); // Re-render logo on change
            },
            addTechnology: (name) => {
                const newTech = { id: Date.now(), name, evaluations: [] };
                appData.technologies.push(newTech);
                return newTech;
            },
            addEvaluation: (techId, evaluationData) => {
                const tech = dataService.getTechnologyById(techId);
                if (tech) tech.evaluations.push(evaluationData);
            },
            addPurpose: (name) => {
                appData.purposes.push({ id: `p${Date.now()}`, name });
            },
             addTechProficiency: (name) => {
                const maxLevel = Math.max(0, ...appData.techProficiencyLevels.map(l => l.id));
                appData.techProficiencyLevels.push({ id: maxLevel + 1, name });
            },
            addConvivialityQuestion: (question) => {
                appData.convivialityQuestions.push({ id: `conv${Date.now()}`, question });
            },
            
            // UPDATERS
            updateFunction: (id, newName, newColor) => {
                const func = appData.functions.find(f => f.id == id);
                if (func) {
                    func.name = newName;
                    func.color = newColor;
                }
            },
            updateFeature: (id, newName, newFunctionId) => {
                const feature = appData.features.find(f => f.id == id);
                if (feature) {
                    feature.name = newName;
                    feature.functionId = newFunctionId;
                }
                renderLogo(); // Re-render logo on change
            },
            updateTechnology: (id, newName, featureIds) => {
                const tech = appData.technologies.find(t => t.id == id);
                if (tech) {
                    tech.name = newName;
                    let adminEval = tech.evaluations.find(ev => ev.isAdminAssigned);
                    if (adminEval) {
                        adminEval.features = featureIds;
                    } else {
                        tech.evaluations.push({ 
                            features: featureIds, 
                            isAdminAssigned: true,
                            comment: "Admin-assigned features.", 
                            convivialityScore: 0, 
                            techProficiency: 0, 
                            groupSize: 1,
                            purposes: [] 
                        });
                    }
                }
            },
             updatePurpose: (id, newName) => {
                const item = appData.purposes.find(p => p.id == id);
                if (item) item.name = newName;
            },
            updateTechProficiency: (id, newName) => {
                const item = appData.techProficiencyLevels.find(l => l.id == id);
                if (item) item.name = newName;
            },
            updateConvivialityQuestion: (id, newQuestion) => {
                const item = appData.convivialityQuestions.find(q => q.id == id);
                if (item) item.question = newQuestion;
            },

            // DELETERS
            deleteFunction: (id) => {
                appData.functions = appData.functions.filter(f => f.id != id);
                appData.features = appData.features.filter(f => f.functionId != id);
                renderLogo(); // Re-render logo on change
            },
            deleteFeature: (id) => {
                appData.features = appData.features.filter(f => f.id != id);
                renderLogo(); // Re-render logo on change
            },
            deleteTechnology: (id) => {
                appData.technologies = appData.technologies.filter(t => t.id != id);
            },
            deletePurpose: (id) => {
                appData.purposes = appData.purposes.filter(p => p.id != id);
            },
            deleteTechProficiency: (id) => {
                appData.techProficiencyLevels = appData.techProficiencyLevels.filter(l => l.id != id);
            },
             deleteConvivialityQuestion: (id) => {
                appData.convivialityQuestions = appData.convivialityQuestions.filter(q => q.id != id);
            }
        };

        // --- ELEMENTS ---
        const pageContents = document.querySelectorAll('.page-content');
        const homeLogo = document.getElementById('home-logo');
        const technologiesListContainer = document.getElementById('technologies-list-container');
        const assembleFeaturesContainer = document.getElementById('assemble-features-container');
        const assembleResultsContainer = document.getElementById('assemble-results-container');
        const evaluateTechSelect = document.getElementById('evaluate-tech-select');
        const newTechnologyInput = document.getElementById('new-technology-input');
        const evaluateTechProficiency = document.getElementById('evaluate-tech-proficiency');
        const evaluateFeaturesSearch = document.getElementById('evaluate-features-search');
        const evaluateFeaturesContainer = document.getElementById('evaluate-features-container');
        const newPurposeInput = document.getElementById('new-purpose-input');
        const saveEvaluationButton = document.getElementById('save-evaluation-button');
        const evaluationComment = document.getElementById('evaluation-comment');
        const convivialitySlidersContainer = document.getElementById('conviviality-sliders-container');
        const saveConfirmationMessage = document.getElementById('save-confirmation-message');
        const saveErrorMessage = document.getElementById('save-error-message');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminDashboardContainer = document.getElementById('admin-dashboard-container');
        const versionTracker = document.getElementById('version-tracker');

        // New Slider Elements
        const assembleTechSlider = document.getElementById('assemble-tech-slider');
        const assembleSizeSlider = document.getElementById('assemble-size-slider');
        const assembleTechDisplay = document.getElementById('assemble-tech-display');
        const assembleSizeDisplay = document.getElementById('assemble-size-display');
        
        const evaluateTechSlider = document.getElementById('evaluate-tech-slider');
        const evaluateSizeSlider = document.getElementById('evaluate-size-slider');
        const evaluateTechDisplay = document.getElementById('evaluate-tech-display');
        const evaluateSizeDisplay = document.getElementById('evaluate-size-display');
        
        const assembleFlossFilter = document.getElementById('assemble-floss-filter');


        // --- HELPERS ---
        const getAggregateData = (technology) => {
            const adminEval = technology.evaluations.find(ev => ev.isAdminAssigned);
            const userEvals = technology.evaluations.filter(ev => !ev.isAdminAssigned);

            const features = adminEval ? adminEval.features : [...new Set(userEvals.flatMap(ev => ev.features))];
            
            const functionIds = [...new Set(features.map(featureId => {
                const feature = dataService.getFeatureById(featureId);
                return feature ? feature.functionId : null;
            }).filter(Boolean))];

            if (userEvals.length === 0) {
                 return { conviviality: null, proficiency: null, groupSize: null, features, functionIds };
            }

            const totalConv = userEvals.reduce((sum, ev) => sum + ev.convivialityScore, 0);
            const totalProf = userEvals.reduce((sum, ev) => sum + ev.techProficiency, 0);
            const totalSize = userEvals.reduce((sum, ev) => sum + (ev.groupSize || 2), 0); // Default to 2 if undefined

            return {
                conviviality: totalConv / userEvals.length,
                proficiency: totalProf / userEvals.length,
                groupSize: totalSize / userEvals.length,
                features,
                functionIds
            };
        };
        
        const getScoreColor = (score, type) => {
            if (score === null) return 'text-gray-400';
            if (type === 'conviviality') {
                if (score >= 7) return 'text-green-600';
                else if (score >= 4) return 'text-yellow-600';
                else return 'text-red-600';
            } else if (type === 'tech') {
                if (score >= 4) return 'text-red-600';
                else if (score >= 2.5) return 'text-yellow-600';
                else return 'text-green-600';
            }
            return 'text-gray-700';
        };

        const updateSliderDisplay = (slider, display, type) => {
            const val = parseInt(slider.value);
            if (type === 'tech') {
                const level = dataService.getTechProficiencyLevels().find(l => l.id === val);
                display.textContent = level ? level.name : '';
            } else {
                const level = dataService.getGroupSizes().find(l => l.id === val);
                display.textContent = level ? level.name : '';
            }
        };

        const renderLogo = () => {
            const container = document.getElementById('home-logo');
            if (!container) return;
            container.innerHTML = '';
            
            const funcs = dataService.getFunctions();
            // Count features per function
            const counts = funcs.map(func => {
                const count = dataService.getFeaturesByFunction(func.id).length;
                return { ...func, count: Math.max(count, 1) }; // Min size 1
            });
            
            // Venn Diagram Logic (Simplified for CSS)
            // We place them in a circle
            const radius = 25; // radius of the circle of centers
            const center = 50; // center of container (percentage)
            
            counts.forEach((func, index) => {
                const angle = (index / counts.length) * 2 * Math.PI;
                const x = center + radius * Math.cos(angle);
                const y = center + radius * Math.sin(angle);
                
                // Scale bubble size based on feature count
                // Base size 30%, max additional based on count relative to total
                const size = 30 + (func.count * 2.5); 
                
                const bubble = document.createElement('div');
                bubble.className = 'logo-bubble shadow-sm';
                bubble.style.backgroundColor = func.color;
                bubble.style.left = `${x}%`;
                bubble.style.top = `${y}%`;
                bubble.style.width = `${size}%`;
                bubble.style.height = `${size}%`;
                bubble.style.transform = 'translate(-50%, -50%)'; // Center on coordinate
                bubble.title = `${func.name}: ${func.count} features`;
                
                container.appendChild(bubble);
            });
        };

        // --- STATE MANAGEMENT ---
        const showPage = (pageId) => {
            // Fade out current active
            const current = document.querySelector('.page-content.active');
            if(current && current.id !== pageId) {
                current.classList.remove('active');
            }
            
            // Activate new page
            pageContents.forEach(page => {
                if (page.id === pageId) {
                    page.classList.add('active');
                    window.scrollTo(0,0);
                    
                    if(page.id === 'assemble-page') {
                        renderAssembleView();
                        const selectedCheckboxes = assembleFeaturesContainer.querySelectorAll('input[type="checkbox"]:checked');
                        const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
                        renderAssembleResults(selectedIds);
                    }
                    if(page.id === 'evaluate-page') {
                        renderEvaluateView();
                    }
                    if(page.id === 'technologies-page') {
                        renderTechnologiesList(technologiesListContainer, 'technologies');
                    }
                    if(page.id === 'admin-dashboard-page') {
                        renderAdminDashboard();
                    }
                }
            });
        };
        
        // --- RENDER FUNCTIONS ---
        const updateVersionTracker = () => {
            versionTracker.textContent = `v${dataService.getVersion().toFixed(1)}`;
        };

        const renderConvivialitySliders = () => {
            convivialitySlidersContainer.innerHTML = dataService.getConvivialityQuestions().map(q => `
                <div>
                    <div class="flex justify-between mb-1">
                        <label class="text-xs text-gray-600">${q.question}</label>
                        <span class="text-xs font-bold text-gray-800" id="val-${q.id}">5</span>
                    </div>
                    <input type="range" min="1" max="10" value="5" class="w-full" data-conv-id="${q.id}" oninput="document.getElementById('val-${q.id}').textContent = this.value">
                    <div class="flex justify-between text-[10px] text-gray-400 mt-1">
                        <span>Low</span>
                        <span>High</span>
                    </div>
                </div>
            `).join('');
        };
        
        const renderAssembleView = () => {
            // Update labels based on current slider values
            updateSliderDisplay(assembleTechSlider, assembleTechDisplay, 'tech');
            updateSliderDisplay(assembleSizeSlider, assembleSizeDisplay, 'size');

            const allFeatures = dataService.getFeatures();
            // Preserve checked state if re-rendering (though sidebar usually static)
            // For now simply re-render
            const existingContainer = document.getElementById('assemble-features-container');
            const checkedIds = Array.from(existingContainer.querySelectorAll('input:checked')).map(cb => cb.value);

            assembleFeaturesContainer.innerHTML = allFeatures.map(feat => {
                const newFlag = feat.isNew ? '<span class="new-flag">new</span>' : '';
                const isChecked = checkedIds.includes(feat.id) ? 'checked' : '';
                return `
                    <label class="flex items-start space-x-3 cursor-pointer p-2 hover:bg-gray-50 rounded transition-colors group">
                        <input type="checkbox" value="${feat.id}" class="feature-checkbox mt-1" ${isChecked}>
                        <div class="text-sm text-gray-700 group-hover:text-gray-900 transition-colors">
                            ${feat.name}
                            ${newFlag}
                        </div>
                    </label>
                `;
            }).join('');
        };
        
        const renderAssembleResults = (selectedFeatureIds = []) => {
            assembleResultsContainer.innerHTML = '';
            
            // Get constraints
            const maxProficiency = parseInt(assembleTechSlider.value);
            const targetGroupSize = parseInt(assembleSizeSlider.value);
            const strictlyOpenSource = assembleFlossFilter.checked;

            if (selectedFeatureIds.length === 0) {
                 assembleResultsContainer.innerHTML = `
                    <div class="text-center py-12 border-2 border-dashed border-gray-200 rounded-lg">
                        <p class="text-gray-400">Select features on the left to see results.</p>
                    </div>
                 `;
                 return;
            }

            const rankedTech = dataService.getTechnologies().map(tech => {
                const aggData = getAggregateData(tech);
                const matchScore = selectedFeatureIds.reduce((score, sfid) => {
                    return score + (aggData.features.includes(sfid) ? 1 : 0);
                }, 0);
                
                // FILTERING LOGIC
                // 1. Tech Proficiency
                if (aggData.proficiency && aggData.proficiency > maxProficiency + 0.5) return null;

                // 2. Group Size
                if (aggData.groupSize && Math.abs(aggData.groupSize - targetGroupSize) > 1.5) return null;
                
                // 3. Strictly Open Source
                if (strictlyOpenSource && !tech.isOpenSource) return null;

                return { ...tech, matchScore, aggData };
            }).filter(tech => tech && tech.matchScore > 0);

            rankedTech.sort((a, b) => {
                if (b.matchScore !== a.matchScore) {
                    return b.matchScore - a.matchScore;
                }
                if ((b.aggData.conviviality || 0) !== (a.aggData.conviviality || 0)) {
                    return (b.aggData.conviviality || 0) - (a.aggData.conviviality || 0);
                }
                return (a.aggData.proficiency || 10) - (b.aggData.proficiency || 10);
            });


            if (rankedTech.length === 0) {
                 assembleResultsContainer.innerHTML = `
                    <div class="p-6 bg-yellow-50 text-yellow-800 rounded-lg border border-yellow-100">
                        <h4 class="font-bold mb-2">No matches found</h4>
                        <p class="text-sm">Try increasing your <strong>Technology knowledge</strong> slider or adjusting the <strong>Group Size</strong> to see more options.${strictlyOpenSource ? '<br>You can also try unchecking "Strictly Open Source".' : ''}</p>
                    </div>`;
                 return;
            }

            const headerHTML = `
                <div class="grid grid-cols-[1fr_auto] gap-4 text-xs text-gray-400 font-bold uppercase tracking-wider mb-4 border-b pb-2">
                    <span>Technology</span>
                    <div class="grid grid-cols-2 gap-6">
                        <span class="w-16 text-center">Match</span>
                        <span class="w-16 text-center">Conviv.</span>
                    </div>
                </div>
            `;
            assembleResultsContainer.innerHTML = headerHTML;

            const relevantFunctionIds = [...new Set(rankedTech.flatMap(t => t.aggData.functionIds))];

            dataService.getFunctions().forEach(func => {
                const techForFunc = rankedTech.filter(t => t.aggData.functionIds.includes(func.id));
                if (techForFunc.length > 0) {
                    const techHTML = techForFunc.map(t => {
                        const scores = t.aggData;
                        const convScoreText = scores.conviviality !== null ? scores.conviviality.toFixed(1) : '-';
                        const matchText = `${t.matchScore}/${selectedFeatureIds.length}`;
                        return `
                            <div class="bg-white border border-gray-100 rounded-lg shadow-sm mb-2 overflow-hidden hover:shadow-md transition-shadow">
                                <div class="grid grid-cols-[1fr_auto] gap-4 items-center text-sm p-4">
                                    <div class="flex items-center tech-name-button font-medium text-gray-800" data-tech-id="${t.id}">
                                        <span class="caret text-gray-400 text-xs">&#9656;</span>
                                        <span>${t.name}</span>
                                        ${t.isOpenSource ? '<span class="ml-2 px-1.5 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700 border border-green-200" title="Open Source">FLOSS</span>' : ''}
                                    </div>
                                    <div class="grid grid-cols-2 gap-6">
                                        <span class="font-bold w-16 text-center text-blue-500 bg-blue-50 rounded py-1">${matchText}</span>
                                        <span class="font-bold w-16 text-center py-1 ${getScoreColor(scores.conviviality, 'conviviality')}">${convScoreText}</span>
                                    </div>
                                </div>
                                <div id="comments-assemble-${t.id}" class="hidden text-sm bg-gray-50 border-t border-gray-100 p-4"></div>
                            </div>
                        `;
                    }).join('');

                    const funcResultEl = document.createElement('div');
                    funcResultEl.innerHTML = `
                        <div class="flex items-center space-x-2 mb-3 mt-6">
                            <div style="background-color: ${func.color}" class="w-3 h-3 rounded-full"></div>
                            <h4 class="font-bold text-gray-700 text-sm uppercase tracking-wide">${func.name}</h4>
                        </div>
                        <div class="space-y-1">${techHTML}</div>
                    `;
                    assembleResultsContainer.appendChild(funcResultEl);
                }
            });
        };

        const renderEvaluateView = () => {
            renderTechnologyDropdown();
            renderEvaluateFeatures();
            renderEvaluatePurposes();
            renderConvivialitySliders();
            updateSliderDisplay(evaluateTechSlider, evaluateTechDisplay, 'tech');
            updateSliderDisplay(evaluateSizeSlider, evaluateSizeDisplay, 'size');
        };

        const renderTechnologyDropdown = () => {
            evaluateTechSelect.innerHTML = '<option value="">Select a technology...</option>';
            dataService.getTechnologies().forEach(tech => {
                const option = document.createElement('option');
                option.value = tech.id;
                option.textContent = tech.name;
                evaluateTechSelect.appendChild(option);
            });
        };
        
        const renderEvaluateFeatures = (searchTerm = '') => {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const allFeatures = dataService.getFeatures();
            evaluateFeaturesContainer.innerHTML = allFeatures
                .filter(feat => feat.name.toLowerCase().includes(lowerCaseSearchTerm))
                .map(feat => `
                <label class="flex items-start space-x-2 text-sm p-1 hover:bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" value="${feat.id}" class="mt-1 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                    <span class="text-gray-700">${feat.name}</span>
                </label>
            `).join('');
        };
        
        const renderEvaluatePurposes = () => {
            document.getElementById('evaluate-purposes-container').innerHTML = '';
            dataService.getPurposes().forEach(purpose => {
                const purposeHTML = `
                    <label class="flex items-center space-x-2 text-sm p-1 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="checkbox" value="${purpose.id}" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                        <span class="text-gray-700">${purpose.name}</span>
                    </label>
                `;
                document.getElementById('evaluate-purposes-container').innerHTML += purposeHTML;
            });
        };

        const renderTechnologiesList = (container, viewName) => {
            container.innerHTML = '';
            
            const headerHTML = `
                 <div class="grid grid-cols-[1fr_auto] gap-4 text-xs text-gray-400 font-bold uppercase tracking-wider mb-4 border-b pb-2">
                    <span>Technology</span>
                    <div class="grid grid-cols-2 gap-6">
                        <span class="w-16 text-center">Conviv.</span>
                        <span class="w-16 text-center">Tech knowledge</span>
                    </div>
                </div>
            `;
            container.innerHTML = headerHTML;

            dataService.getFunctions().forEach(func => {
                let techForFunc = dataService.getTechnologies().filter(t => getAggregateData(t).functionIds.includes(func.id));
                
                techForFunc.sort((a, b) => {
                    const scoreA = getAggregateData(a);
                    const scoreB = getAggregateData(b);
                    if ((scoreB.conviviality || 0) !== (scoreA.conviviality || 0)) {
                        return (scoreB.conviviality || 0) - (scoreA.conviviality || 0);
                    }
                    return (scoreA.proficiency || 10) - (scoreB.proficiency || 10);
                });

                if (techForFunc.length > 0) {
                    const techHTML = techForFunc.map(t => {
                        const scores = getAggregateData(t);
                        const convScoreText = scores.conviviality !== null ? scores.conviviality.toFixed(1) : '-';
                        const techScoreText = scores.proficiency !== null ? scores.proficiency.toFixed(1) : '-';
                        return `
                        <div class="bg-white border border-gray-100 rounded-lg shadow-sm mb-2 overflow-hidden hover:shadow-md transition-shadow">
                            <div class="grid grid-cols-[1fr_auto] gap-4 items-center text-sm p-4">
                                <div class="flex items-center tech-name-button font-medium text-gray-800" data-tech-id="${t.id}">
                                    <span class="caret text-gray-400 text-xs">&#9656;</span>
                                    <span>${t.name}</span>
                                    ${t.isOpenSource ? '<span class="ml-2 px-1.5 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700 border border-green-200" title="Open Source">FLOSS</span>' : ''}
                                </div>
                                <div class="grid grid-cols-2 gap-6">
                                   <span class="font-bold w-16 text-center py-1 ${getScoreColor(scores.conviviality, 'conviviality')}">${convScoreText}</span>
                                   <span class="font-bold w-16 text-center py-1 ${getScoreColor(scores.proficiency, 'tech')}">${techScoreText}</span>
                                </div>
                            </div>
                            <div id="comments-${viewName}-${t.id}" class="hidden text-sm bg-gray-50 border-t border-gray-100 p-4"></div>
                        </div>
                    `}).join('');
                    
                    const funcResultEl = document.createElement('div');
                    funcResultEl.innerHTML = `
                        <div class="flex items-center space-x-2 mb-3 mt-6">
                            <div style="background-color: ${func.color}" class="w-3 h-3 rounded-full"></div>
                            <h4 class="font-bold text-gray-700 text-sm uppercase tracking-wide">${func.name}</h4>
                        </div>
                        <div class="space-y-1">${techHTML}</div>
                    `;
                    container.appendChild(funcResultEl);
                }
            });
        };
        
        const renderAdminDashboard = () => {
            adminDashboardContainer.innerHTML = `
                <div class="space-y-12">
                    <!-- Functions -->
                    <div>
                        <h3 class="text-xl font-bold mb-4 flex items-center"><span class="bg-gray-200 text-gray-700 rounded px-2 py-1 text-xs mr-2">Core</span>Manage Functions</h3>
                        <table class="admin-table">
                            <thead><tr><th>Name</th><th>Color</th><th class="w-40 text-right">Actions</th></tr></thead>
                            <tbody id="admin-functions-body"></tbody>
                        </table>
                        <form id="add-function-form" class="mt-4 flex space-x-2"><input type="text" placeholder="New function name" class="form-input flex-grow"><button type="submit" class="action-button text-sm !py-2 !px-4">Add</button></form>
                    </div>
                    <!-- Features -->
                    <div>
                        <h3 class="text-xl font-bold mb-4 flex items-center"><span class="bg-gray-200 text-gray-700 rounded px-2 py-1 text-xs mr-2">Core</span>Manage Features</h3>
                        <table class="admin-table">
                            <thead><tr><th>Name</th><th>Function</th><th>Used By</th><th class="w-40 text-right">Actions</th></tr></thead>
                            <tbody id="admin-features-body"></tbody>
                        </table>
                         <form id="add-feature-form" class="mt-4 flex space-x-2"><input type="text" placeholder="New feature name" class="form-input flex-grow"><select id="add-feature-function-select" class="form-input w-1/3"></select><button type="submit" class="action-button text-sm !py-2 !px-4">Add</button></form>
                    </div>
                    <!-- Technologies -->
                    <div>
                         <h3 class="text-xl font-bold mb-4 flex items-center"><span class="bg-gray-200 text-gray-700 rounded px-2 py-1 text-xs mr-2">Content</span>Manage Technologies</h3>
                        <table class="admin-table">
                            <thead><tr><th>Name</th><th>Associated Features</th><th class="w-40 text-right">Actions</th></tr></thead>
                            <tbody id="admin-technologies-body"></tbody>
                        </table>
                         <form id="add-technology-form" class="mt-4 flex space-x-2"><input type="text" placeholder="New technology name" class="form-input flex-grow"><button type="submit" class="action-button text-sm !py-2 !px-4">Add</button></form>
                    </div>
                </div>
            `;
            renderAdminTables();
        };

        const renderAdminTables = () => {
            // Functions
            document.getElementById('admin-functions-body').innerHTML = dataService.getFunctions().map(f => `
                <tr data-id="${f.id}" data-type="function">
                    <td>
                        <span class="view-mode font-medium">${f.name}</span>
                        <input type="text" value="${f.name}" class="form-input edit-mode hidden">
                    </td>
                    <td>
                        <span class="view-mode flex items-center"><div style="background-color:${f.color}" class="w-4 h-4 mr-2 border rounded-full"></div> ${f.color}</span>
                        <input type="color" value="${f.color}" class="form-input edit-mode hidden h-8 w-16">
                    </td>
                    <td class="text-right">
                        <button class="text-blue-600 hover:text-blue-800 text-xs font-semibold mr-3" data-action="edit">Edit</button>
                        <button class="text-red-500 hover:text-red-700 text-xs font-semibold" data-action="delete">Delete</button>
                    </td>
                </tr>`).join('');

            // Features
            const functionOptions = dataService.getFunctions().map(f => `<option value="${f.id}">${f.name}</option>`).join('');
            document.getElementById('add-feature-function-select').innerHTML = functionOptions;
            document.getElementById('admin-features-body').innerHTML = dataService.getFeatures().map(f => {
                const functionName = dataService.getFunctions().find(fn => fn.id === f.functionId)?.name || 'N/A';
                const techList = dataService.getTechnologies().filter(t => getAggregateData(t).features.includes(f.id));
                const techListHTML = techList.length > 0 ? `<div class="text-xs text-gray-500">${techList.map(t => t.name).join(', ')}</div>` : '<span class="text-xs text-gray-300">Unused</span>';

                return `
                <tr data-id="${f.id}" data-type="feature">
                    <td>
                        <span class="view-mode font-medium">${f.name}</span>
                        <input type="text" value="${f.name}" class="form-input edit-mode hidden">
                    </td>
                    <td>
                        <span class="view-mode bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">${functionName}</span>
                        <select class="form-input edit-mode hidden text-sm">${functionOptions.replace(`value="${f.functionId}"`, `value="${f.functionId}" selected`)}</select>
                    </td>
                    <td><div class="view-mode">${techListHTML}</div></td>
                    <td class="text-right">
                        <button class="text-blue-600 hover:text-blue-800 text-xs font-semibold mr-3" data-action="edit">Edit</button>
                        <button class="text-red-500 hover:text-red-700 text-xs font-semibold" data-action="delete">Delete</button>
                    </td>
                </tr>`;
            }).join('');

            // Technologies
            document.getElementById('admin-technologies-body').innerHTML = dataService.getTechnologies().map(t => {
                const aggData = getAggregateData(t);
                const featureList = `<div class="flex flex-wrap gap-1">${aggData.features.map(fid => `<span class="bg-gray-100 border border-gray-200 text-gray-600 px-2 py-1 rounded text-xs">${dataService.getFeatureById(fid)?.name || ''}</span>`).join('')}</div>`;
                
                const unassociatedFeatures = dataService.getFeatures().filter(f => !aggData.features.includes(f.id));
                const addFeatureContainerHTML = unassociatedFeatures.length > 0 ? `
                    <div class="add-feature-container flex space-x-2 mt-2 bg-white p-1 rounded border border-gray-200">
                        <select class="form-input flex-grow text-xs h-8 py-0">${unassociatedFeatures.map(f => `<option value="${f.id}">${f.name}</option>`).join('')}</select>
                        <button class="text-xs action-button !py-0 !px-3 h-8 flex items-center" data-action="add-feature">Add</button>
                    </div>` : '';

                const editModeFeaturesHTML = `
                    <div class="edit-mode-features-list space-y-1">
                        ${aggData.features.map(fid => {
                            const feature = dataService.getFeatureById(fid);
                            return feature ? `<div class="edit-mode-item text-xs" data-feature-id="${fid}"><span>${feature.name}</span><button class="text-red-500 hover:text-red-700 font-bold ml-2" data-action="remove-feature">&times;</button></div>` : '';
                        }).join('')}
                    </div>
                    ${addFeatureContainerHTML}`;

                return `
                <tr data-id="${t.id}" data-type="technology">
                    <td>
                        <span class="view-mode font-bold">${t.name}</span>
                        <input type="text" value="${t.name}" class="form-input edit-mode hidden">
                    </td>
                    <td>
                        <div class="view-mode">${aggData.features.length > 0 ? featureList : '<span class="text-gray-400 italic">No features associated</span>'}</div>
                        <div class="edit-mode hidden">${editModeFeaturesHTML}</div>
                    </td>
                    <td class="text-right">
                        <button class="text-blue-600 hover:text-blue-800 text-xs font-semibold mr-3" data-action="edit">Edit</button>
                        <button class="text-red-500 hover:text-red-700 text-xs font-semibold" data-action="delete">Delete</button>
                    </td>
                </tr>`;
            }).join('');
        };

        // --- EVENT LISTENERS ---
        document.addEventListener('click', (e) => {
            const navLink = e.target.closest('.nav-link');
            if (navLink) {
                e.preventDefault();
                const pageId = navLink.getAttribute('href').substring(1) + '-page';
                showPage(pageId);
                
                // Update URL hash without scrolling
                history.pushState(null, null, navLink.getAttribute('href'));
            }
            if (e.target.closest('#home-logo')) {
                showPage('main-content');
                history.pushState(null, null, '#');
            }
            if (e.target.id === 'admin-logout') {
                 showPage('main-content');
            }
        });

        document.getElementById('admin-login-link').addEventListener('click', (e) => {
            e.preventDefault();
            showPage('admin-login-page');
        });

        adminLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('admin-login-error');
            if (email === 'admin@cos.com' && password === 'password') {
                errorEl.classList.add('hidden');
                showPage('admin-dashboard-page');
            } else {
                errorEl.classList.remove('hidden');
            }
        });
        
        adminDashboardContainer.addEventListener('click', (e) => {
            const target = e.target;
            const action = target.dataset.action;
            const row = target.closest('tr');
            if (!row && !(action === 'add-feature' || action === 'remove-feature')) return;

            const id = row?.dataset.id;
            const type = row?.dataset.type;

            if (action === 'edit') {
                row.querySelectorAll('.view-mode').forEach(el => el.classList.add('hidden'));
                row.querySelectorAll('.edit-mode').forEach(el => el.classList.remove('hidden'));
                target.textContent = 'Save';
                target.dataset.action = 'save';
                target.classList.remove('text-blue-600');
                target.classList.add('text-green-600');
                // Hide 'add' dropdown if no options
                if(type === 'technology'){
                    const select = row.querySelector('.add-feature-container select');
                    if (select && select.options.length === 0) {
                        row.querySelector('.add-feature-container').classList.add('hidden');
                    }
                }
            } else if (action === 'save') {
                if (type === 'function') {
                    const newName = row.querySelector('input[type="text"]').value;
                    const newColor = row.querySelector('input[type="color"]').value;
                    dataService.updateFunction(id, newName, newColor);
                } else if (type === 'technology') {
                    const newName = row.querySelector('input[type="text"]').value;
                    const featureList = row.querySelector('.edit-mode-features-list');
                    const featureIds = Array.from(featureList.children).map(child => child.dataset.featureId);
                    dataService.updateTechnology(id, newName, featureIds);
                } else if (type === 'feature') {
                     const newName = row.querySelector('input[type="text"]').value;
                     const newFunctionId = row.querySelector('select').value;
                     dataService.updateFeature(id, newName, newFunctionId);
                }
                renderAdminTables();
            } else if (action === 'delete') {
                if (confirm('Are you sure you want to delete this item?')) {
                    if (type === 'function') dataService.deleteFunction(id);
                    if (type === 'feature') dataService.deleteFeature(id);
                    if (type === 'technology') dataService.deleteTechnology(id);
                    renderAdminTables();
                }
            } else if (action === 'add-feature') {
                const techRow = target.closest('tr');
                const select = target.previousElementSibling;
                const featureId = select.value;
                if (!featureId) return;
                const feature = dataService.getFeatureById(featureId);
                const list = techRow.querySelector('.edit-mode-features-list');
                const newItem = document.createElement('div');
                newItem.className = 'edit-mode-item text-xs';
                newItem.dataset.featureId = featureId;
                newItem.innerHTML = `<span>${feature.name}</span><button class="text-red-500 hover:text-red-700 font-bold ml-2" data-action="remove-feature">&times;</button>`;
                list.appendChild(newItem);
                select.remove(select.selectedIndex);
                if (select.options.length === 0) {
                    techRow.querySelector('.add-feature-container').classList.add('hidden');
                }
            } else if (action === 'remove-feature') {
                const techRow = target.closest('tr');
                const item = target.closest('.edit-mode-item');
                const featureId = item.dataset.featureId;
                const feature = dataService.getFeatureById(featureId);
                const select = techRow.querySelector('.edit-mode select');
                const newOption = document.createElement('option');
                newOption.value = featureId;
                newOption.textContent = feature.name;
                select.appendChild(newOption);
                techRow.querySelector('.add-feature-container').classList.remove('hidden');
                item.remove();
            }
        });

        adminDashboardContainer.addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const input = form.querySelector('input');
            const name = input.value.trim();
            if (!name) return;

            if (form.id === 'add-function-form') dataService.addFunction(name);
            if (form.id === 'add-feature-form') {
                const functionId = form.querySelector('select').value;
                dataService.addFeature(name, functionId);
            }
            if (form.id === 'add-technology-form') dataService.addTechnology(name);
            
            input.value = '';
            renderAdminTables();
        });
        
        assembleFeaturesContainer.addEventListener('change', () => {
            const selectedCheckboxes = assembleFeaturesContainer.querySelectorAll('input[type="checkbox"]:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            renderAssembleResults(selectedIds);
        });

        // Sliders event listeners
        assembleTechSlider.addEventListener('input', () => {
             updateSliderDisplay(assembleTechSlider, assembleTechDisplay, 'tech');
             const selectedCheckboxes = assembleFeaturesContainer.querySelectorAll('input[type="checkbox"]:checked');
             const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
             renderAssembleResults(selectedIds);
        });

        assembleSizeSlider.addEventListener('input', () => {
             updateSliderDisplay(assembleSizeSlider, assembleSizeDisplay, 'size');
             const selectedCheckboxes = assembleFeaturesContainer.querySelectorAll('input[type="checkbox"]:checked');
             const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
             renderAssembleResults(selectedIds);
        });
        
        assembleFlossFilter.addEventListener('change', () => {
             const selectedCheckboxes = assembleFeaturesContainer.querySelectorAll('input[type="checkbox"]:checked');
             const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
             renderAssembleResults(selectedIds);
        });

        evaluateTechSlider.addEventListener('input', () => {
             updateSliderDisplay(evaluateTechSlider, evaluateTechDisplay, 'tech');
        });

        evaluateSizeSlider.addEventListener('input', () => {
             updateSliderDisplay(evaluateSizeSlider, evaluateSizeDisplay, 'size');
        });

        newTechnologyInput.addEventListener('keypress', (e) => {
             if (e.key === 'Enter' && newTechnologyInput.value.trim() !== '') {
                e.preventDefault();
                const newTech = dataService.addTechnology(newTechnologyInput.value.trim());
                renderEvaluateView();
                evaluateTechSelect.value = newTech.id;
                newTechnologyInput.value = '';
            }
        });
        
        evaluateFeaturesSearch.addEventListener('keyup', (e) => {
            renderEvaluateFeatures(e.target.value);
        });
        
        newPurposeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && newPurposeInput.value.trim() !== '') {
                e.preventDefault();
                dataService.addPurpose(newPurposeInput.value.trim());
                renderEvaluatePurposes();
                newPurposeInput.value = '';
            }
        });
        
        saveEvaluationButton.addEventListener('click', () => {
            saveErrorMessage.classList.add('hidden');
            saveConfirmationMessage.classList.add('hidden');

            const techId = parseInt(evaluateTechSelect.value);
            if (!techId) {
                saveErrorMessage.textContent = 'Please select a technology to evaluate.';
                saveErrorMessage.classList.remove('hidden');
                return;
            }
            const technology = dataService.getTechnologyById(techId);
            
            const convSliders = convivialitySlidersContainer.querySelectorAll('input[type="range"]');
            const totalConvScore = Array.from(convSliders).reduce((sum, slider) => sum + parseInt(slider.value), 0);
            const avgConvScore = totalConvScore / convSliders.length;

            const newEvaluation = {
                techProficiency: parseInt(evaluateTechSlider.value), // Use slider value
                groupSize: parseInt(evaluateSizeSlider.value),       // Use slider value
                convivialityScore: avgConvScore,
                comment: evaluationComment.value,
                features: Array.from(document.getElementById('evaluate-features-container').querySelectorAll('input:checked')).map(cb => cb.value),
                purposes: Array.from(document.getElementById('evaluate-purposes-container').querySelectorAll('input:checked')).map(cb => cb.value),
            };
            
            dataService.addEvaluation(techId, newEvaluation);
            dataService.incrementVersion();
            updateVersionTracker();
            
            saveConfirmationMessage.classList.remove('hidden');
            setTimeout(() => saveConfirmationMessage.classList.add('hidden'), 3000);

            // Clear form
            const form = document.getElementById('evaluate-form-container');
            form.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
            form.querySelectorAll('textarea, input[type="search"]').forEach(t => t.value = '');
            // Uncheck boxes
            form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            // Reset sliders
            convSliders.forEach(s => {
                s.value = 5;
                const display = document.getElementById(`val-${s.dataset.convId}`);
                if(display) display.textContent = '5';
            });
            // Reset main sliders
            evaluateTechSlider.value = 3; updateSliderDisplay(evaluateTechSlider, evaluateTechDisplay, 'tech');
            evaluateSizeSlider.value = 2; updateSliderDisplay(evaluateSizeSlider, evaluateSizeDisplay, 'size');

            renderEvaluateFeatures();
            renderEvaluatePurposes();
        });
        
        const handleCommentToggle = (event) => {
            const button = event.target.closest('.tech-name-button');
            if (button) {
                const techId = button.dataset.techId;
                const view = event.currentTarget.dataset.view;
                const commentsContainer = document.getElementById(`comments-${view}-${techId}`);
                const caret = button.querySelector('.caret');
                
                commentsContainer.classList.toggle('hidden');
                caret.classList.toggle('caret-open');

                if (!commentsContainer.classList.contains('hidden')) {
                     const technology = dataService.getTechnologyById(parseInt(techId));
                     const aggData = getAggregateData(technology);
                     
                     let featuresHTML = '<p class="font-semibold mb-1">Supported Features:</p>';
                     if (aggData.features.length > 0) {
                         const featureList = aggData.features.map(fid => {
                            const feature = dataService.getFeatureById(fid);
                            return `<li class="ml-4">${feature ? feature.name : 'Unknown feature'}</li>`;
                         }).join('');
                         featuresHTML += `<ul class="list-disc list-outside mb-4 text-gray-600">${featureList}</ul>`;
                     } else {
                         featuresHTML += '<p class="text-gray-500 italic mb-4">No features listed.</p>';
                     }

                     let commentsHTML = '<p class="font-semibold mb-2">User Reviews:</p>';
                     const comments = technology.evaluations.filter(ev => ev.comment && ev.comment.trim() !== '' && !ev.isAdminAssigned);
                     if (comments.length > 0) {
                        commentsHTML += comments.map(ev => `<div class="bg-white p-3 rounded border border-gray-200 mb-2 italic text-gray-600">"${ev.comment}"</div>`).join('');
                     } else {
                        commentsHTML += '<p class="text-gray-500 italic">No comments yet.</p>';
                     }

                     commentsContainer.innerHTML = featuresHTML + commentsHTML;
                }
            }
        };

        assembleResultsContainer.dataset.view = 'assemble';
        technologiesListContainer.dataset.view = 'technologies';
        assembleResultsContainer.addEventListener('click', handleCommentToggle);
        technologiesListContainer.addEventListener('click', handleCommentToggle);
        
        // --- ROUTING & INITIALIZATION ---
        const handleRouting = () => {
            const hash = window.location.hash || '#';
            const pageId = hash.substring(1) ? hash.substring(1) + '-page' : 'main-content';
            showPage(pageId);
        };

        window.addEventListener('hashchange', handleRouting);
        handleRouting(); // Initial page load
        updateVersionTracker();
        renderLogo(); // Render initial logo
    });
    </script>
</body>
</html>
